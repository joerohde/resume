<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
	<head>
		<meta http-equiv="content-type" content="text/html; charset=utf-8" />
		<meta name="robots" content="all" />
		<meta name="generator" content="RapidWeaver" />
		
		<title>Tree.h</title>
		<link rel="stylesheet" type="text/css" media="screen" href="../rw_common/themes/interslice/styles.css"  />
		<link rel="stylesheet" type="text/css" media="print" href="../rw_common/themes/interslice/print.css"  />
		<link rel="stylesheet" type="text/css" media="handheld" href="../rw_common/themes/interslice/handheld.css"  />
		<link rel="stylesheet" type="text/css" media="screen" href="../rw_common/themes/interslice/css/width/width_variable.css" />
		<link rel="stylesheet" type="text/css" media="screen" href="../rw_common/themes/interslice/css/sidebar/sidebar_left.css" />
		
		
		
		
		<script type="text/javascript" src="../rw_common/themes/interslice/javascript.js"></script>
		
		
		
	</head>
<body>
<div id="container"><!-- Start container -->
	
	<div id="pageHeader"><!-- Start page header -->
		
		<h1>Joe Rohde's Info</h1>
		<h2>Will Code For Food</h2>
	</div><!-- End page header -->
	
	<div id="sidebarContainer"><!-- Start Sidebar wrapper -->
		<div id="navcontainer"><!-- Start Navigation -->
			<ul><li><a href="../index.html" rel="self">Code Samples</a></li><li><a href="../Pages/CArenaAllocator.html" rel="self">CArenaAllocator.h</a></li><li><a href="../Pages/CArenaAllocator_cpp.html" rel="self">CArenaAllocator.cpp</a></li><li><a href="Tree.html" rel="self" id="current">Tree.h</a></li><li><a href="../Pages/TreeMain.html" rel="self">TreeMain.cpp</a></li><li><a href="../Pages/TreeOutput.html" rel="self">Tree Output</a></li><li><a href="../Pages/DirectedGraph.html" rel="self">DirectedGraph.h</a></li><li><a href="../Pages/Instruction.html" rel="self">Instruction.h</a></li><li><a href="../Pages/Instruction_cpp.html" rel="self">Instruction.cpp</a></li><li><a href="../Pages/TestHarness.html" rel="self">TestHarness.cpp</a></li></ul>
		</div><!-- End navigation --> 
		<div id="sidebar"><!-- Start sidebar content -->
			<h1 class="sideHeader"></h1><!-- Sidebar header -->
			 <br /><!-- sidebar content you enter in the page inspector -->
			 <!-- sidebar content such as the blog archive links -->
		</div><!-- End sidebar content -->
	</div><!-- End sidebar wrapper -->
	
	<div id="contentContainer"><!-- Start main content wrapper -->
		<div id="content"><!-- Start content -->
			<H1>Tree.h</H1>
<div style="font-family: Bitstream Vera Sans Mono; font-size: 10pt; color: black; background: white;">
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;&nbsp;&nbsp;1</span>&nbsp;<span style="color: blue;">#pragma</span> <span style="color: blue;">once</span></pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;&nbsp;&nbsp;2</span>&nbsp;</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;&nbsp;&nbsp;3</span>&nbsp;<span style="color: purple;">// To see the interesting parts of this code, prefer looking at (in order of interest):</span></pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;&nbsp;&nbsp;4</span>&nbsp;<span style="color: purple;">// - SelectRandom</span></pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;&nbsp;&nbsp;5</span>&nbsp;<span style="color: purple;">// - TraverseRandom</span></pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;&nbsp;&nbsp;6</span>&nbsp;<span style="color: purple;">// - RotateLeft/Right</span></pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;&nbsp;&nbsp;7</span>&nbsp;<span style="color: purple;">// - Insert</span></pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;&nbsp;&nbsp;8</span>&nbsp;<span style="color: purple;">// - AssertValid</span></pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;&nbsp;&nbsp;9</span>&nbsp;<span style="color: purple;">// Bits having to do with the 'random' stuff are commented //RND</span></pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;&nbsp;10</span>&nbsp;</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;&nbsp;11</span>&nbsp;<span style="color: purple;">// This is a simple red black tree built from Sedgwick's reference description</span></pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;&nbsp;12</span>&nbsp;<span style="color: purple;">// and code snippets as well as his 2-3-4 tree description.&nbsp; It is non-optimized</span></pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;&nbsp;13</span>&nbsp;<span style="color: purple;">// since this code is about showing the mixing in of the weighted random selection</span></pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;&nbsp;14</span>&nbsp;<span style="color: purple;">// algorithm.&nbsp; Weighting of 0 remove the item from consideration for selection.</span></pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;&nbsp;15</span>&nbsp;</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;&nbsp;16</span>&nbsp;<span style="color: purple;">// Things that should be done to make this more 'real'.</span></pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;&nbsp;17</span>&nbsp;<span style="color: purple;">//</span></pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;&nbsp;18</span>&nbsp;<span style="color: purple;">// - Get rid of the recursion; and subsequently determine if it's better</span></pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;&nbsp;19</span>&nbsp;<span style="color: purple;">//&nbsp;&nbsp; to have keep stacks around, or just add parent pointers to the Node type.</span></pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;&nbsp;20</span>&nbsp;<span style="color: purple;">//</span></pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;&nbsp;21</span>&nbsp;<span style="color: purple;">// - Support custom memory allocators, or at least have a decent allocation</span></pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;&nbsp;22</span>&nbsp;<span style="color: purple;">//&nbsp;&nbsp; story if this is to be heavily used.</span></pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;&nbsp;23</span>&nbsp;<span style="color: purple;">//</span></pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;&nbsp;24</span>&nbsp;<span style="color: purple;">// - Make it STL-Like</span></pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;&nbsp;25</span>&nbsp;<span style="color: purple;">//</span></pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;&nbsp;26</span>&nbsp;<span style="color: purple;">// - Support STL Iterators</span></pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;&nbsp;27</span>&nbsp;<span style="color: purple;">//</span></pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;&nbsp;28</span>&nbsp;<span style="color: purple;">// - Make it thread safe</span></pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;&nbsp;29</span>&nbsp;<span style="color: purple;">//</span></pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;&nbsp;30</span>&nbsp;<span style="color: purple;">// - Better error handling.&nbsp; This one just has asserts and return values.</span></pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;&nbsp;31</span>&nbsp;<span style="color: purple;">//&nbsp;&nbsp; Often exception handling really is a better choice (especially on</span></pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;&nbsp;32</span>&nbsp;<span style="color: purple;">//&nbsp;&nbsp; x64/Itanic architectures).</span></pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;&nbsp;33</span>&nbsp;<span style="color: purple;">//</span></pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;&nbsp;34</span>&nbsp;<span style="color: purple;">// - Add constraints on TData to force comparability and copy constructability</span></pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;&nbsp;35</span>&nbsp;<span style="color: purple;">//&nbsp;&nbsp; and a Weight() method or interface.</span></pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;&nbsp;36</span>&nbsp;<span style="color: purple;">//</span></pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;&nbsp;37</span>&nbsp;<span style="color: purple;">// - To make things more readable null checks are typically done on input</span></pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;&nbsp;38</span>&nbsp;<span style="color: purple;">//&nbsp;&nbsp; parameters of recursive functions.&nbsp; Nice for readability, but an extra</span></pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;&nbsp;39</span>&nbsp;<span style="color: purple;">//&nbsp;&nbsp; level of recursion without a /really/ good optimizer. &lt;shrug&gt;</span></pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;&nbsp;40</span>&nbsp;<span style="color: purple;">//</span></pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;&nbsp;41</span>&nbsp;</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;&nbsp;42</span>&nbsp;</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;&nbsp;43</span>&nbsp;<span style="color: blue;">template</span> &lt;<span style="color: blue;">typename</span> TData&gt;</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;&nbsp;44</span>&nbsp;<span style="color: blue;">class</span> Tree</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;&nbsp;45</span>&nbsp;{</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;&nbsp;46</span>&nbsp;<span style="color: purple;">// public types</span></pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;&nbsp;47</span>&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: blue;">typedef</span> <span style="color: blue;">void</span> (TData::* TraverseCallBack)(<span style="color: blue;">void</span>);</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;&nbsp;48</span>&nbsp;</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;&nbsp;49</span>&nbsp;<span style="color: purple;">// Interface</span></pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;&nbsp;50</span>&nbsp;<span style="color: blue;">public</span>:</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;&nbsp;51</span>&nbsp;&nbsp;&nbsp;&nbsp; Tree(<span style="color: blue;">void</span>);</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;&nbsp;52</span>&nbsp;&nbsp;&nbsp;&nbsp; ~Tree(<span style="color: blue;">void</span>);</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;&nbsp;53</span>&nbsp;</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;&nbsp;54</span>&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: blue;">void</span> Add(<span style="color: blue;">const</span> TData &amp;data);</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;&nbsp;55</span>&nbsp;</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;&nbsp;56</span>&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: purple;">// Don't have time to re-implement this exercise in tedium.&nbsp; It barely impacts</span></pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;&nbsp;57</span>&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: purple;">// the weighted random algorithm any more than insert, except the book-keeping</span></pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;&nbsp;58</span>&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: purple;">// during the normal 'bst delete' at the start.</span></pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;&nbsp;59</span>&nbsp;</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;&nbsp;60</span>&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: purple;">// bool Remove(const TData &amp;data); // return true if removed</span></pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;&nbsp;61</span>&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: purple;">// size_t Count() const; // eh, easy to implement later.</span></pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;&nbsp;62</span>&nbsp;</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;&nbsp;63</span>&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: blue;">void</span> TraverseInOrder(TraverseCallBack callback) <span style="color: blue;">const</span>;</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;&nbsp;64</span>&nbsp;</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;&nbsp;65</span>&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: purple;">//RND Select a random item, by weighted preference.</span></pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;&nbsp;66</span>&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: blue;">bool</span> SelectRandom(TraverseCallBack callback, <span style="color: blue;">bool</span> bAllowRepeat = <span style="color: blue;">false</span>) <span style="color: blue;">const</span>;</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;&nbsp;67</span>&nbsp;</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;&nbsp;68</span>&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: purple;">//RND visit each node exactly once in the weighted random order.</span></pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;&nbsp;69</span>&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: blue;">void</span> TraverseRandom(TraverseCallBack callback) <span style="color: blue;">const</span>;</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;&nbsp;70</span>&nbsp;</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;&nbsp;71</span>&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: purple;">//RND set all the weights back to original values</span></pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;&nbsp;72</span>&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: blue;">void</span> ResetWeights();</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;&nbsp;73</span>&nbsp;</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;&nbsp;74</span>&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: purple;">// Verify RedBlack properties, and calidate integrity of weighted values</span></pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;&nbsp;75</span>&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: blue;">void</span> AssertValid() <span style="color: blue;">const</span>;</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;&nbsp;76</span>&nbsp;</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;&nbsp;77</span>&nbsp;<span style="color: purple;">// Internal data types</span></pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;&nbsp;78</span>&nbsp;<span style="color: blue;">private</span>:</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;&nbsp;79</span>&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: blue;">typedef</span> <span style="color: blue;">struct</span> Node</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;&nbsp;80</span>&nbsp;&nbsp;&nbsp;&nbsp; {</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;&nbsp;81</span>&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; Node&nbsp;&nbsp;&nbsp; *pLeft;</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;&nbsp;82</span>&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; Node&nbsp;&nbsp;&nbsp; *pRight;</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;&nbsp;83</span>&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; size_t&nbsp;&nbsp;&nbsp; nWeight;</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;&nbsp;84</span>&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; <span style="color: blue;">unsigned</span></pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;&nbsp;85</span>&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; <span style="color: blue;">__int64</span>&nbsp;&nbsp;&nbsp; nSummedWeight;</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;&nbsp;86</span>&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; TData&nbsp;&nbsp;&nbsp; data;</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;&nbsp;87</span>&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; <span style="color: blue;">bool</span>&nbsp;&nbsp;&nbsp; bRed;</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;&nbsp;88</span>&nbsp;</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;&nbsp;89</span>&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; <span style="color: purple;">// a theoretical 2-3-4 'node'.</span></pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;&nbsp;90</span>&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; Node(<span style="color: blue;">const</span> TData &amp;srcData) : data(srcData), pLeft(NULL), pRight(NULL), bRed(<span style="color: blue;">true</span>), nWeight(srcData.Weight())</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;&nbsp;91</span>&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; {</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;&nbsp;92</span>&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; <span style="color: purple;">// initialize this explicitely so as to never confuse anyone who isn't clear</span></pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;&nbsp;93</span>&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; <span style="color: purple;">// about constructor initialization order being dependant on declaration.</span></pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;&nbsp;94</span>&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; <span style="color: purple;">// (ie: insulate ourselves from someone re-ordering the struct, while avoiding</span></pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;&nbsp;95</span>&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; <span style="color: purple;">// calling srcData.Weight() twice since we don't know if that call is expensive or not).</span></pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;&nbsp;96</span>&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; nSummedWeight = nWeight;</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;&nbsp;97</span>&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; }</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;&nbsp;98</span>&nbsp;</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;&nbsp;99</span>&nbsp;&nbsp;&nbsp;&nbsp; } *PNODE;</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;100</span>&nbsp;</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;101</span>&nbsp;<span style="color: purple;">// Internal Methods</span></pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;102</span>&nbsp;<span style="color: blue;">private</span>:</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;103</span>&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: purple;">// return value is the weight on the new data</span></pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;104</span>&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: blue;">static</span> size_t Insert(PNODE &amp;pCurrent, <span style="color: blue;">const</span> TData &amp;data, <span style="color: blue;">bool</span> bRed);</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;105</span>&nbsp;</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;106</span>&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: purple;">// callback will be called when selection hit</span></pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;107</span>&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: blue;">static</span> size_t SelectRandom(<span style="color: blue;">const</span> PNODE pNode, <span style="color: blue;">unsigned</span> <span style="color: blue;">__int64</span> nRandom, TraverseCallBack callback, <span style="color: blue;">bool</span> bAllowRepeat);</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;108</span>&nbsp;</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;109</span>&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: purple;">// destructor helper</span></pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;110</span>&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: blue;">static</span> <span style="color: blue;">void</span> DeleteFromRoot(PNODE pNode);</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;111</span>&nbsp;</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;112</span>&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: purple;">// Helpers to make null checking less intrusive</span></pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;113</span>&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: blue;">static</span> <span style="color: blue;">bool</span> IsRed(<span style="color: blue;">const</span> PNODE pn) { <span style="color: blue;">return</span> pn ? pn-&gt;bRed : <span style="color: blue;">false</span>; }</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;114</span>&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: blue;">static</span> <span style="color: blue;">unsigned</span> <span style="color: blue;">__int64</span> GetSummedWeight(<span style="color: blue;">const</span> PNODE pn) { <span style="color: blue;">return</span> pn ? pn-&gt;nSummedWeight : 0; }</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;115</span>&nbsp;</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;116</span>&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: purple;">// Universal</span></pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;117</span>&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: blue;">static</span> <span style="color: blue;">void</span> RotateLeft(PNODE &amp;pNode);</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;118</span>&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: blue;">static</span> <span style="color: blue;">void</span> RotateRight(PNODE &amp;pNode);</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;119</span>&nbsp;</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;120</span>&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: purple;">// recursion helper</span></pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;121</span>&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: blue;">static</span> <span style="color: blue;">void</span> Traverse(PNODE pNode, TraverseCallBack callback);</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;122</span>&nbsp;</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;123</span>&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: blue;">static</span> <span style="color: blue;">unsigned</span> <span style="color: blue;">__int64</span> ResetWeight(PNODE pNode);</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;124</span>&nbsp;</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;125</span>&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: purple;">// Verify RedBlack properties, and validate integrity of weighted values</span></pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;126</span>&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: blue;">static</span> <span style="color: blue;">unsigned</span> <span style="color: blue;">__int64</span> AssertValid(<span style="color: blue;">const</span> PNODE pNode, <span style="color: blue;">int</span> nBlackCountSeen, <span style="color: blue;">int</span> *pnBlackTotal);</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;127</span>&nbsp;</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;128</span>&nbsp;<span style="color: purple;">// Internal data</span></pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;129</span>&nbsp;<span style="color: blue;">private</span>:</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;130</span>&nbsp;&nbsp;&nbsp;&nbsp; PNODE&nbsp;&nbsp;&nbsp; m_pRoot;</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;131</span>&nbsp;};</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;132</span>&nbsp;</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;133</span>&nbsp;<span style="color: blue;">template</span>&lt;<span style="color: blue;">typename</span> TData&gt;</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;134</span>&nbsp;Tree&lt;TData&gt;::Tree()</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;135</span>&nbsp;: m_pRoot(NULL)</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;136</span>&nbsp;{</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;137</span>&nbsp;</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;138</span>&nbsp;}</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;139</span>&nbsp;</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;140</span>&nbsp;<span style="color: blue;">template</span>&lt;<span style="color: blue;">typename</span> TData&gt;</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;141</span>&nbsp;Tree&lt;TData&gt;::~Tree()</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;142</span>&nbsp;{</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;143</span>&nbsp;&nbsp;&nbsp;&nbsp; DeleteFromRoot(m_pRoot);</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;144</span>&nbsp;}</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;145</span>&nbsp;</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;146</span>&nbsp;<span style="color: blue;">template</span>&lt;<span style="color: blue;">typename</span> TData&gt;</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;147</span>&nbsp;<span style="color: blue;">void</span> Tree&lt;TData&gt;::DeleteFromRoot(PNODE pNode)</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;148</span>&nbsp;{</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;149</span>&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: blue;">if</span> (pNode)</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;150</span>&nbsp;&nbsp;&nbsp;&nbsp; {</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;151</span>&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; <span style="color: blue;">if</span> (pNode-&gt;pLeft) DeleteFromRoot(pNode-&gt;pLeft);</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;152</span>&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; <span style="color: blue;">if</span> (pNode-&gt;pRight) DeleteFromRoot(pNode-&gt;pRight);</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;153</span>&nbsp;</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;154</span>&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; <span style="color: blue;">delete</span> pNode;</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;155</span>&nbsp;&nbsp;&nbsp;&nbsp; }</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;156</span>&nbsp;}</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;157</span>&nbsp;</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;158</span>&nbsp;<span style="color: blue;">template</span>&lt;<span style="color: blue;">typename</span> TData&gt;</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;159</span>&nbsp;<span style="color: blue;">void</span> Tree&lt;TData&gt;::Add(<span style="color: blue;">const</span> TData &amp;data)</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;160</span>&nbsp;{</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;161</span>&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: purple;">// Pretty much right from Sedgewick</span></pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;162</span>&nbsp;&nbsp;&nbsp;&nbsp; Insert(m_pRoot, data, <span style="color: blue;">false</span>);</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;163</span>&nbsp;&nbsp;&nbsp;&nbsp; m_pRoot-&gt;bRed = <span style="color: blue;">false</span>;</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;164</span>&nbsp;}</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;165</span>&nbsp;</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;166</span>&nbsp;<span style="color: blue;">template</span>&lt;<span style="color: blue;">typename</span> TData&gt;</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;167</span>&nbsp;size_t Tree&lt;TData&gt;::Insert(PNODE &amp;pCurrent, <span style="color: blue;">const</span> TData &amp;data, <span style="color: blue;">bool</span> bFlip)</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;168</span>&nbsp;{</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;169</span>&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: blue;">if</span> (NULL == pCurrent)</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;170</span>&nbsp;&nbsp;&nbsp;&nbsp; {&nbsp;&nbsp;&nbsp; <span style="color: purple;">// Root not set</span></pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;171</span>&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; pCurrent = <span style="color: blue;">new</span> Node(data);</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;172</span>&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; <span style="color: blue;">return</span> pCurrent-&gt;nWeight;</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;173</span>&nbsp;&nbsp;&nbsp;&nbsp; }</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;174</span>&nbsp;</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;175</span>&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: blue;">if</span> (data == pCurrent-&gt;data)</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;176</span>&nbsp;&nbsp;&nbsp;&nbsp; { <span style="color: purple;">// match. Replace it since equality is not the same as identity, assume we want the 'freshest' item</span></pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;177</span>&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; pCurrent-&gt;data = data;</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;178</span>&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; pCurrent-&gt;nWeight = data.Weight();</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;179</span>&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; pCurrent-&gt;nSummedWeight = pCurrent-&gt;nWeight + GetSummedWeight(pCurrent-&gt;pLeft) + GetSummedWeight(pCurrent-&gt;pRight);</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;180</span>&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; <span style="color: blue;">return</span> pCurrent-&gt;nWeight;</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;181</span>&nbsp;&nbsp;&nbsp;&nbsp; }</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;182</span>&nbsp;</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;183</span>&nbsp;&nbsp;&nbsp;&nbsp; size_t nWeight;</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;184</span>&nbsp;</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;185</span>&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: purple;">// 4 node, split it now, fix it on the way back up.</span></pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;186</span>&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: blue;">if</span> (IsRed(pCurrent-&gt;pLeft) &amp;&amp; (IsRed(pCurrent-&gt;pRight)))</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;187</span>&nbsp;&nbsp;&nbsp;&nbsp; {</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;188</span>&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; pCurrent-&gt;bRed = <span style="color: blue;">true</span>;</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;189</span>&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; pCurrent-&gt;pLeft-&gt;bRed = <span style="color: blue;">false</span>;</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;190</span>&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; pCurrent-&gt;pRight-&gt;bRed = <span style="color: blue;">false</span>;</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;191</span>&nbsp;&nbsp;&nbsp;&nbsp; }</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;192</span>&nbsp;</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;193</span>&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: blue;">if</span> (data &lt; pCurrent-&gt;data)</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;194</span>&nbsp;&nbsp;&nbsp;&nbsp; { <span style="color: purple;">// go left</span></pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;195</span>&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; nWeight = Insert(pCurrent-&gt;pLeft, data, <span style="color: blue;">false</span>);</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;196</span>&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; pCurrent-&gt;nSummedWeight += nWeight;</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;197</span>&nbsp;</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;198</span>&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; <span style="color: blue;">if</span> (IsRed(pCurrent) &amp;&amp; IsRed(pCurrent-&gt;pLeft) &amp;&amp; bFlip)</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;199</span>&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; {</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;200</span>&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; RotateRight(pCurrent);</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;201</span>&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; }</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;202</span>&nbsp;</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;203</span>&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; <span style="color: purple;">// pCurrent-&gt;pLeft-&gt;pLeft won't deref null because of short circuit eval on the left side</span></pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;204</span>&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; <span style="color: blue;">if</span> (IsRed(pCurrent-&gt;pLeft) &amp;&amp; IsRed(pCurrent-&gt;pLeft-&gt;pLeft))</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;205</span>&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; {</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;206</span>&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; RotateRight(pCurrent);</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;207</span>&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; pCurrent-&gt;bRed = <span style="color: blue;">false</span>;</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;208</span>&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; pCurrent-&gt;pRight-&gt;bRed = <span style="color: blue;">true</span>;</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;209</span>&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; }</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;210</span>&nbsp;&nbsp;&nbsp;&nbsp; }</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;211</span>&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: blue;">else</span></pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;212</span>&nbsp;&nbsp;&nbsp;&nbsp; { <span style="color: purple;">// go right</span></pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;213</span>&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; nWeight = Insert(pCurrent-&gt;pRight, data, <span style="color: blue;">true</span>);</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;214</span>&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; pCurrent-&gt;nSummedWeight += nWeight;</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;215</span>&nbsp;</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;216</span>&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; <span style="color: blue;">if</span> (IsRed(pCurrent) &amp;&amp; IsRed(pCurrent-&gt;pRight) &amp;&amp; !bFlip)</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;217</span>&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; {</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;218</span>&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; RotateLeft(pCurrent);</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;219</span>&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; }</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;220</span>&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; <span style="color: blue;">if</span> (IsRed(pCurrent-&gt;pRight) &amp;&amp; IsRed(pCurrent-&gt;pRight-&gt;pRight))</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;221</span>&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; {</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;222</span>&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; RotateLeft(pCurrent);</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;223</span>&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; pCurrent-&gt;bRed = <span style="color: blue;">false</span>;</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;224</span>&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; pCurrent-&gt;pLeft-&gt;bRed = <span style="color: blue;">true</span>;</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;225</span>&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; }</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;226</span>&nbsp;&nbsp;&nbsp;&nbsp; }</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;227</span>&nbsp;</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;228</span>&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: blue;">return</span> nWeight;</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;229</span>&nbsp;}</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;230</span>&nbsp;</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;231</span>&nbsp;<span style="color: purple;">//RND</span></pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;232</span>&nbsp;<span style="color: blue;">template</span>&lt;<span style="color: blue;">typename</span> TData&gt;</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;233</span>&nbsp;<span style="color: blue;">void</span> Tree&lt;TData&gt;::ResetWeights()</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;234</span>&nbsp;{&nbsp;&nbsp;&nbsp; </pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;235</span>&nbsp;&nbsp;&nbsp;&nbsp; ResetWeight(m_pRoot);</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;236</span>&nbsp;}</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;237</span>&nbsp;</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;238</span>&nbsp;<span style="color: blue;">template</span>&lt;<span style="color: blue;">typename</span> TData&gt;</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;239</span>&nbsp;<span style="color: blue;">unsigned</span> <span style="color: blue;">__int64</span> Tree&lt;TData&gt;::ResetWeight(PNODE pNode)</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;240</span>&nbsp;{</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;241</span>&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: blue;">if</span> (NULL == pNode)</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;242</span>&nbsp;&nbsp;&nbsp;&nbsp; {</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;243</span>&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; <span style="color: blue;">return</span> 0;</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;244</span>&nbsp;&nbsp;&nbsp;&nbsp; }</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;245</span>&nbsp;</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;246</span>&nbsp;&nbsp;&nbsp;&nbsp; pNode-&gt;nWeight = pNode-&gt;data.Weight();</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;247</span>&nbsp;&nbsp;&nbsp;&nbsp; pNode-&gt;nSummedWeight = pNode-&gt;nWeight;</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;248</span>&nbsp;</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;249</span>&nbsp;&nbsp;&nbsp;&nbsp; pNode-&gt;nSummedWeight += ResetWeight(pNode-&gt;pLeft);</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;250</span>&nbsp;&nbsp;&nbsp;&nbsp; pNode-&gt;nSummedWeight += ResetWeight(pNode-&gt;pRight);</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;251</span>&nbsp;</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;252</span>&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: blue;">return</span> pNode-&gt;nSummedWeight;</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;253</span>&nbsp;}</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;254</span>&nbsp;</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;255</span>&nbsp;<span style="color: purple;">//RND Select a random item, by weighted preference.</span></pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;256</span>&nbsp;<span style="color: blue;">template</span>&lt;<span style="color: blue;">typename</span> TData&gt;</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;257</span>&nbsp;<span style="color: blue;">bool</span> Tree&lt;TData&gt;::SelectRandom(TraverseCallBack callback, <span style="color: blue;">bool</span> bAllowRepeat) <span style="color: blue;">const</span></pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;258</span>&nbsp;{</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;259</span>&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: blue;">if</span> ((NULL == m_pRoot) || (m_pRoot-&gt;nSummedWeight == 0))</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;260</span>&nbsp;&nbsp;&nbsp;&nbsp; {</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;261</span>&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; <span style="color: blue;">return</span> <span style="color: blue;">false</span>;</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;262</span>&nbsp;&nbsp;&nbsp;&nbsp; }</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;263</span>&nbsp;</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;264</span>&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: blue;">__int64</span> nRandom = rand();</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;265</span>&nbsp;&nbsp;&nbsp;&nbsp; nRandom = (nRandom &lt;&lt; 32) | rand();</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;266</span>&nbsp;&nbsp;&nbsp;&nbsp; nRandom %= m_pRoot-&gt;nSummedWeight;</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;267</span>&nbsp;</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;268</span>&nbsp;&nbsp;&nbsp;&nbsp; SelectRandom(m_pRoot, nRandom, callback, bAllowRepeat);</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;269</span>&nbsp;</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;270</span>&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: blue;">return</span> <span style="color: blue;">true</span>;</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;271</span>&nbsp;}</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;272</span>&nbsp;</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;273</span>&nbsp;<span style="color: purple;">//RND: The selector</span></pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;274</span>&nbsp;<span style="color: blue;">template</span>&lt;<span style="color: blue;">typename</span> TData&gt;</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;275</span>&nbsp;size_t Tree&lt;TData&gt;::SelectRandom(<span style="color: blue;">const</span> PNODE pNode, <span style="color: blue;">unsigned</span> <span style="color: blue;">__int64</span> nRandom, TraverseCallBack callback, <span style="color: blue;">bool</span> bAllowRepeat)</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;276</span>&nbsp;{</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;277</span>&nbsp;&nbsp;&nbsp;&nbsp; ASSERT(pNode);</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;278</span>&nbsp;</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;279</span>&nbsp;&nbsp;&nbsp;&nbsp; size_t nWeight = pNode-&gt;nWeight;</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;280</span>&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: blue;">if</span> (nRandom &lt; nWeight)</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;281</span>&nbsp;&nbsp;&nbsp;&nbsp; {</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;282</span>&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; <span style="color: blue;">if</span> (!bAllowRepeat) pNode-&gt;nWeight = 0;</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;283</span>&nbsp;</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;284</span>&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; (pNode-&gt;data.*callback)();</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;285</span>&nbsp;&nbsp;&nbsp;&nbsp; }</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;286</span>&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: blue;">else</span></pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;287</span>&nbsp;&nbsp;&nbsp;&nbsp; {</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;288</span>&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; nRandom -= nWeight;</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;289</span>&nbsp;</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;290</span>&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; <span style="color: blue;">if</span> (nRandom &lt; GetSummedWeight(pNode-&gt;pLeft))</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;291</span>&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; {</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;292</span>&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; nWeight = SelectRandom(pNode-&gt;pLeft, nRandom, callback, bAllowRepeat);</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;293</span>&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; }</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;294</span>&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; <span style="color: blue;">else</span></pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;295</span>&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; {</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;296</span>&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; nRandom -= GetSummedWeight(pNode-&gt;pLeft);</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;297</span>&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; nWeight = SelectRandom(pNode-&gt;pRight, nRandom, callback, bAllowRepeat);</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;298</span>&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; }</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;299</span>&nbsp;&nbsp;&nbsp;&nbsp; }</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;300</span>&nbsp;</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;301</span>&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: blue;">if</span> (!bAllowRepeat)</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;302</span>&nbsp;&nbsp;&nbsp;&nbsp; {</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;303</span>&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; pNode-&gt;nSummedWeight -= nWeight;</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;304</span>&nbsp;&nbsp;&nbsp;&nbsp; }</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;305</span>&nbsp;</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;306</span>&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: blue;">return</span> nWeight;</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;307</span>&nbsp;}</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;308</span>&nbsp;</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;309</span>&nbsp;<span style="color: purple;">//RND visit each node exactly once in the weighted random order.</span></pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;310</span>&nbsp;<span style="color: blue;">template</span>&lt;<span style="color: blue;">typename</span> TData&gt;</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;311</span>&nbsp;<span style="color: blue;">void</span> Tree&lt;TData&gt;::TraverseRandom(TraverseCallBack callback) <span style="color: blue;">const</span></pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;312</span>&nbsp;{</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;313</span>&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: blue;">while</span> (SelectRandom(callback, <span style="color: blue;">false</span>))</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;314</span>&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; ;</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;315</span>&nbsp;}</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;316</span>&nbsp;</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;317</span>&nbsp;<span style="color: blue;">template</span>&lt;<span style="color: blue;">typename</span> TData&gt;</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;318</span>&nbsp;<span style="color: blue;">void</span> Tree&lt;TData&gt;::TraverseInOrder(TraverseCallBack callback) <span style="color: blue;">const</span></pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;319</span>&nbsp;{</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;320</span>&nbsp;&nbsp;&nbsp;&nbsp; Traverse(m_pRoot, callback);</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;321</span>&nbsp;}</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;322</span>&nbsp;</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;323</span>&nbsp;<span style="color: blue;">template</span>&lt;<span style="color: blue;">typename</span> TData&gt;</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;324</span>&nbsp;<span style="color: blue;">void</span> Tree&lt;TData&gt;::Traverse(PNODE pNode, TraverseCallBack callback)</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;325</span>&nbsp;{</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;326</span>&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: blue;">if</span> (NULL == pNode) <span style="color: blue;">return</span>;</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;327</span>&nbsp;</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;328</span>&nbsp;&nbsp;&nbsp;&nbsp; Traverse(pNode-&gt;pLeft, callback);</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;329</span>&nbsp;</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;330</span>&nbsp;&nbsp;&nbsp;&nbsp; (pNode-&gt;data.*callback)();</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;331</span>&nbsp;</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;332</span>&nbsp;&nbsp;&nbsp;&nbsp; Traverse(pNode-&gt;pRight, callback);</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;333</span>&nbsp;}</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;334</span>&nbsp;</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;335</span>&nbsp;<span style="color: purple;">//RND: As the items rotate, the weighted sums must be kept in sync</span></pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;336</span>&nbsp;<span style="color: blue;">template</span>&lt;<span style="color: blue;">typename</span> TData&gt;</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;337</span>&nbsp;<span style="color: blue;">void</span> Tree&lt;TData&gt;::RotateLeft(PNODE &amp;pNode)</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;338</span>&nbsp;{</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;339</span>&nbsp;&nbsp;&nbsp;&nbsp; PNODE pRight = pNode-&gt;pRight;</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;340</span>&nbsp;</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;341</span>&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: purple;">// Update the counts first</span></pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;342</span>&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: purple;">// The point of the rotate is that the right child exists and</span></pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;343</span>&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: purple;">// replaces the current node. So pick up that weight.</span></pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;344</span>&nbsp;&nbsp;&nbsp;&nbsp; pRight-&gt;nSummedWeight = pNode-&gt;nSummedWeight;</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;345</span>&nbsp;</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;346</span>&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: purple;">// The current node will 'lose' the weight of right's right tree and right itself.</span></pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;347</span>&nbsp;&nbsp;&nbsp;&nbsp; pNode-&gt;nSummedWeight -= (GetSummedWeight(pRight-&gt;pRight) + pRight-&gt;nWeight);</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;348</span>&nbsp;</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;349</span>&nbsp;&nbsp;&nbsp;&nbsp; pNode-&gt;pRight = pRight-&gt;pLeft;</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;350</span>&nbsp;&nbsp;&nbsp;&nbsp; pRight-&gt;pLeft = pNode;</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;351</span>&nbsp;&nbsp;&nbsp;&nbsp; pNode = pRight;</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;352</span>&nbsp;}</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;353</span>&nbsp;</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;354</span>&nbsp;<span style="color: purple;">//RND: As the items rotate, the weighted sums must be kept in sync</span></pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;355</span>&nbsp;<span style="color: blue;">template</span>&lt;<span style="color: blue;">typename</span> TData&gt;</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;356</span>&nbsp;<span style="color: blue;">void</span> Tree&lt;TData&gt;::RotateRight(PNODE &amp;pNode)</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;357</span>&nbsp;{</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;358</span>&nbsp;&nbsp;&nbsp;&nbsp; PNODE pLeft = pNode-&gt;pLeft;</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;359</span>&nbsp;</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;360</span>&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: purple;">// Update the counts first</span></pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;361</span>&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: purple;">// The point of the rotate is that the left child exists and</span></pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;362</span>&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: purple;">// replaces the current node. So pick up that weight.</span></pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;363</span>&nbsp;&nbsp;&nbsp;&nbsp; pLeft-&gt;nSummedWeight = pNode-&gt;nSummedWeight;</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;364</span>&nbsp;</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;365</span>&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: purple;">// The current node will 'lose' the weight of left's left tree and left iself.</span></pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;366</span>&nbsp;&nbsp;&nbsp;&nbsp; pNode-&gt;nSummedWeight -= (GetSummedWeight(pLeft-&gt;pLeft) + pLeft-&gt;nWeight);</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;367</span>&nbsp;</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;368</span>&nbsp;&nbsp;&nbsp;&nbsp; pNode-&gt;pLeft = pLeft-&gt;pRight;</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;369</span>&nbsp;&nbsp;&nbsp;&nbsp; pLeft-&gt;pRight = pNode;</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;370</span>&nbsp;&nbsp;&nbsp;&nbsp; pNode = pLeft;</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;371</span>&nbsp;}</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;372</span>&nbsp;</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;373</span>&nbsp;<span style="color: purple;">// Return value is the count of black children</span></pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;374</span>&nbsp;<span style="color: blue;">template</span>&lt;<span style="color: blue;">typename</span> TData&gt;</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;375</span>&nbsp;<span style="color: blue;">unsigned</span> <span style="color: blue;">__int64</span> Tree&lt;TData&gt;::AssertValid(<span style="color: blue;">const</span> PNODE pNode, <span style="color: blue;">int</span> nBlackCountSeen, <span style="color: blue;">int</span> *pnBlackTotal)</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;376</span>&nbsp;{</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;377</span>&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: blue;">if</span> (pNode == NULL)</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;378</span>&nbsp;&nbsp;&nbsp;&nbsp; {</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;379</span>&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; <span style="color: blue;">return</span> 0;</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;380</span>&nbsp;&nbsp;&nbsp;&nbsp; }</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;381</span>&nbsp;</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;382</span>&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: purple;">// (2)</span></pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;383</span>&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: blue;">if</span> (IsRed(pNode))</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;384</span>&nbsp;&nbsp;&nbsp;&nbsp; {</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;385</span>&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; ASSERT(!IsRed(pNode-&gt;pLeft));</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;386</span>&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; ASSERT(!IsRed(pNode-&gt;pRight));</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;387</span>&nbsp;&nbsp;&nbsp;&nbsp; }</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;388</span>&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: blue;">else</span></pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;389</span>&nbsp;&nbsp;&nbsp;&nbsp; {</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;390</span>&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; nBlackCountSeen++;</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;391</span>&nbsp;&nbsp;&nbsp;&nbsp; }</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;392</span>&nbsp;</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;393</span>&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: purple;">// (3)</span></pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;394</span>&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: blue;">if</span> ((NULL == pNode-&gt;pLeft) &amp;&amp; (NULL == pNode-&gt;pRight))</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;395</span>&nbsp;&nbsp;&nbsp;&nbsp; {</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;396</span>&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; <span style="color: blue;">if</span> (*pnBlackTotal &lt; 0)</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;397</span>&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; {</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;398</span>&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; *pnBlackTotal = nBlackCountSeen;</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;399</span>&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; }</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;400</span>&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; ASSERT(*pnBlackTotal == nBlackCountSeen);</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;401</span>&nbsp;&nbsp;&nbsp;&nbsp; }</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;402</span>&nbsp;</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;403</span>&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: purple;">//RND (4)</span></pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;404</span>&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: blue;">unsigned</span> <span style="color: blue;">__int64</span> nComputedWeight = pNode-&gt;nWeight;</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;405</span>&nbsp;&nbsp;&nbsp;&nbsp; nComputedWeight += AssertValid(pNode-&gt;pLeft, nBlackCountSeen, pnBlackTotal);</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;406</span>&nbsp;&nbsp;&nbsp;&nbsp; nComputedWeight += AssertValid(pNode-&gt;pRight, nBlackCountSeen, pnBlackTotal);</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;407</span>&nbsp;</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;408</span>&nbsp;&nbsp;&nbsp;&nbsp; ASSERT(nComputedWeight == pNode-&gt;nSummedWeight); <span style="color: purple;">// (5)</span></pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;409</span>&nbsp;</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;410</span>&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: blue;">return</span> nComputedWeight;</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;411</span>&nbsp;}</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;412</span>&nbsp;</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;413</span>&nbsp;<span style="color: purple;">// Properties being validated:</span></pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;414</span>&nbsp;<span style="color: purple;">// (1) The root is black</span></pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;415</span>&nbsp;<span style="color: purple;">// (2) red nodes have only black immediate children</span></pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;416</span>&nbsp;<span style="color: purple;">// (3) count of black nodes on any vertical path is equal.</span></pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;417</span>&nbsp;<span style="color: purple;">//RND</span></pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;418</span>&nbsp;<span style="color: purple;">// (4) Weighted sum of any node is the weight of the node</span></pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;419</span>&nbsp;<span style="color: purple;">//&nbsp;&nbsp; plus the weighted sum of its children.</span></pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;420</span>&nbsp;<span style="color: blue;">template</span>&lt;<span style="color: blue;">typename</span> TData&gt;</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;421</span>&nbsp;<span style="color: blue;">void</span> Tree&lt;TData&gt;::AssertValid() <span style="color: blue;">const</span></pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;422</span>&nbsp;{</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;423</span>&nbsp;<span style="color: blue;">#ifndef</span> _DEBUG</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;424</span>&nbsp;<span style="color: gray;">&nbsp;&nbsp;&nbsp; return true;</span></pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;425</span>&nbsp;<span style="color: blue;">#else</span></pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;426</span>&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: blue;">if</span> (m_pRoot == NULL)</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;427</span>&nbsp;&nbsp;&nbsp;&nbsp; {</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;428</span>&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; <span style="color: blue;">return</span>;</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;429</span>&nbsp;&nbsp;&nbsp;&nbsp; }</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;430</span>&nbsp;</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;431</span>&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: purple;">// (1)</span></pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;432</span>&nbsp;&nbsp;&nbsp;&nbsp; ASSERT(m_pRoot-&gt;bRed == <span style="color: blue;">false</span>);</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;433</span>&nbsp;</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;434</span>&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: blue;">int</span> nBlackPathCount = -1;</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;435</span>&nbsp;&nbsp;&nbsp;&nbsp; AssertValid(m_pRoot, 0, &amp;nBlackPathCount);</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;436</span>&nbsp;</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;437</span>&nbsp;<span style="color: blue;">#endif</span></pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;438</span>&nbsp;}</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;439</span>&nbsp;</pre>
</div>

		</div><!-- End content -->
	</div><!-- End main content wrapper -->
	
	<div class="clearer"></div>
	
	<div id="footer"><!-- Start Footer -->
		<div id="breadcrumbcontainer"><!-- Start the breadcrumb wrapper -->
			
		</div><!-- End breadcrumb -->
		<p>&copy; 2009 Joe Rohde <a href="#" id="rw_email_contact">Contact Me</a><script type="text/javascript">var _rwObsfuscatedHref0 = "mai";var _rwObsfuscatedHref1 = "lto";var _rwObsfuscatedHref2 = ":Jo";var _rwObsfuscatedHref3 = "e.R";var _rwObsfuscatedHref4 = "ohd";var _rwObsfuscatedHref5 = "e@G";var _rwObsfuscatedHref6 = "Mai";var _rwObsfuscatedHref7 = "l.c";var _rwObsfuscatedHref8 = "om";var _rwObsfuscatedHref = _rwObsfuscatedHref0+_rwObsfuscatedHref1+_rwObsfuscatedHref2+_rwObsfuscatedHref3+_rwObsfuscatedHref4+_rwObsfuscatedHref5+_rwObsfuscatedHref6+_rwObsfuscatedHref7+_rwObsfuscatedHref8; document.getElementById('rw_email_contact').href = _rwObsfuscatedHref;</script></p>
	</div><!-- End Footer -->

</div><!-- End container -->
</body>
</html>
