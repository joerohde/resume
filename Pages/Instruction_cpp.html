<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
	<head>
		<meta http-equiv="content-type" content="text/html; charset=utf-8" />
		<meta name="robots" content="all" />
		<meta name="generator" content="RapidWeaver" />
		
		<title>Instruction.cpp</title>
		<link rel="stylesheet" type="text/css" media="screen" href="../rw_common/themes/interslice/styles.css"  />
		<link rel="stylesheet" type="text/css" media="print" href="../rw_common/themes/interslice/print.css"  />
		<link rel="stylesheet" type="text/css" media="handheld" href="../rw_common/themes/interslice/handheld.css"  />
		<link rel="stylesheet" type="text/css" media="screen" href="../rw_common/themes/interslice/css/width/width_variable.css" />
		<link rel="stylesheet" type="text/css" media="screen" href="../rw_common/themes/interslice/css/sidebar/sidebar_left.css" />
		
		
		
		
		<script type="text/javascript" src="../rw_common/themes/interslice/javascript.js"></script>
		
		
		
	</head>
<body>
<div id="container"><!-- Start container -->
	
	<div id="pageHeader"><!-- Start page header -->
		
		<h1>Joe Rohde's Info</h1>
		<h2>Will Code For Food</h2>
	</div><!-- End page header -->
	
	<div id="sidebarContainer"><!-- Start Sidebar wrapper -->
		<div id="navcontainer"><!-- Start Navigation -->
			<ul><li><a href="../index.html" rel="self">Code Samples</a></li><li><a href="../Pages/CArenaAllocator.html" rel="self">CArenaAllocator.h</a></li><li><a href="../Pages/CArenaAllocator_cpp.html" rel="self">CArenaAllocator.cpp</a></li><li><a href="../Pages/Tree.html" rel="self">Tree.h</a></li><li><a href="../Pages/TreeMain.html" rel="self">TreeMain.cpp</a></li><li><a href="../Pages/TreeOutput.html" rel="self">Tree Output</a></li><li><a href="../Pages/DirectedGraph.html" rel="self">DirectedGraph.h</a></li><li><a href="../Pages/Instruction.html" rel="self">Instruction.h</a></li><li><a href="Instruction_cpp.html" rel="self" id="current">Instruction.cpp</a></li><li><a href="../Pages/TestHarness.html" rel="self">TestHarness.cpp</a></li></ul>
		</div><!-- End navigation --> 
		<div id="sidebar"><!-- Start sidebar content -->
			<h1 class="sideHeader"></h1><!-- Sidebar header -->
			 <br /><!-- sidebar content you enter in the page inspector -->
			 <!-- sidebar content such as the blog archive links -->
		</div><!-- End sidebar content -->
	</div><!-- End sidebar wrapper -->
	
	<div id="contentContainer"><!-- Start main content wrapper -->
		<div id="content"><!-- Start content -->
			<div style="font-family: Bitstream Vera Sans Mono; font-size: 10pt; color: black; background: white;">
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;&nbsp;&nbsp;1</span>&nbsp;<span style="color: purple;">// Instruction.cpp : Defines the functions for working with instruction streams.</span></pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;&nbsp;&nbsp;2</span>&nbsp;<span style="color: purple;">//</span></pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;&nbsp;&nbsp;3</span>&nbsp;</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;&nbsp;&nbsp;4</span>&nbsp;<span style="color: blue;">#include</span> <span style="color: #a31515;">&quot;stdafx.h&quot;</span></pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;&nbsp;&nbsp;5</span>&nbsp;</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;&nbsp;&nbsp;6</span>&nbsp;<span style="color: blue;">#include</span> <span style="color: #a31515;">&quot;DirectedGraph.h&quot;</span></pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;&nbsp;&nbsp;7</span>&nbsp;</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;&nbsp;&nbsp;8</span>&nbsp;<span style="color: blue;">#include</span> <span style="color: #a31515;">&quot;Instruction.h&quot;</span></pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;&nbsp;&nbsp;9</span>&nbsp;</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;&nbsp;10</span>&nbsp;<span style="color: purple;">// Helper class that dows the work.</span></pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;&nbsp;11</span>&nbsp;<span style="color: blue;">class</span> BranchResolver</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;&nbsp;12</span>&nbsp;{</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;&nbsp;13</span>&nbsp;<span style="color: blue;">public</span>:</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;&nbsp;14</span>&nbsp;&nbsp;&nbsp;&nbsp; BranchResolver(vector&lt;Instruction&gt; *code);</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;&nbsp;15</span>&nbsp;</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;&nbsp;16</span>&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: blue;">void</span> BuildGraph();</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;&nbsp;17</span>&nbsp;</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;&nbsp;18</span>&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: blue;">void</span> Solve();</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;&nbsp;19</span>&nbsp;</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;&nbsp;20</span>&nbsp;<span style="color: purple;">// Private Data Structures</span></pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;&nbsp;21</span>&nbsp;<span style="color: blue;">private</span>:</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;&nbsp;22</span>&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: blue;">struct</span> BranchArc</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;&nbsp;23</span>&nbsp;&nbsp;&nbsp;&nbsp; {</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;&nbsp;24</span>&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; size_t nInstructionIndex;&nbsp;&nbsp;&nbsp; <span style="color: purple;">// Into the vector&lt;Instruction&gt;</span></pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;&nbsp;25</span>&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; <span style="color: blue;">int</span>&nbsp;&nbsp;&nbsp;&nbsp; nBranchByteOffest;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; <span style="color: purple;">// Signed offset in final bytecode: Assumes unresolved branches take up 0 bytes.</span></pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;&nbsp;26</span>&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; <span style="color: blue;">int</span>&nbsp;&nbsp;&nbsp;&nbsp; nLabelDistance;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; <span style="color: purple;">// Signed offset in bytes of label: Assumes unresolved branches take up 0 bytes.</span></pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;&nbsp;27</span>&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; size_t nFixupDistance;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; <span style="color: purple;">// Unsigned: Used during graph traversal to adjust arcs based on encoding size of surrounded branches</span></pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;&nbsp;28</span>&nbsp;&nbsp;&nbsp;&nbsp; };</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;&nbsp;29</span>&nbsp;</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;&nbsp;30</span>&nbsp;<span style="color: purple;">// Private Data</span></pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;&nbsp;31</span>&nbsp;<span style="color: blue;">private</span>:</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;&nbsp;32</span>&nbsp;&nbsp;&nbsp;&nbsp; vector&lt;Instruction&gt; *m_pCode;</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;&nbsp;33</span>&nbsp;</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;&nbsp;34</span>&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: purple;">// keep a vector of all arcs we see.&nbsp; Not added until</span></pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;&nbsp;35</span>&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: purple;">// we see the branch source, even for back arcs.</span></pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;&nbsp;36</span>&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: blue;">typedef</span> vector&lt;BranchArc&gt; ArcVector;</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;&nbsp;37</span>&nbsp;&nbsp;&nbsp;&nbsp; ArcVector m_arcs;</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;&nbsp;38</span>&nbsp;</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;&nbsp;39</span>&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: purple;">// the nodes in the graph represent arcs in our instructions (the branch span).</span></pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;&nbsp;40</span>&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: purple;">// However our 'data' will just be the index into an arc vector that</span></pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;&nbsp;41</span>&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: purple;">// contains the branch source.</span></pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;&nbsp;42</span>&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: blue;">typedef</span> DirectedGraph&lt;ArcVector::size_type&gt; ArcGraph;</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;&nbsp;43</span>&nbsp;&nbsp;&nbsp;&nbsp; ArcGraph m_graph;</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;&nbsp;44</span>&nbsp;</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;&nbsp;45</span>&nbsp;<span style="color: purple;">// Private Methods</span></pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;&nbsp;46</span>&nbsp;<span style="color: blue;">private</span>:</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;&nbsp;47</span>&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: blue;">bool</span> Traverse(ArcGraph::PNODE pNode);</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;&nbsp;48</span>&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: blue;">bool</span> BreakCycle(ArcGraph::PNODE pNode);</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;&nbsp;49</span>&nbsp;</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;&nbsp;50</span>&nbsp;&nbsp;&nbsp;&nbsp; OpCode GetBranchType(<span style="color: blue;">const</span> ArcGraph::PNODE pNode) <span style="color: blue;">const</span>;</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;&nbsp;51</span>&nbsp;</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;&nbsp;52</span>&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: blue;">static</span> <span style="color: blue;">int</span> ExtendOffset(<span style="color: blue;">int</span> nOriginal, size_t nDistance, <span style="color: blue;">bool</span> bLong);</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;&nbsp;53</span>&nbsp;</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;&nbsp;54</span>&nbsp;};</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;&nbsp;55</span>&nbsp;</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;&nbsp;56</span>&nbsp;<span style="color: blue;">void</span> ResolveBranches(vector&lt;Instruction&gt; *code)</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;&nbsp;57</span>&nbsp;{</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;&nbsp;58</span>&nbsp;&nbsp;&nbsp;&nbsp; BranchResolver resolver(code);</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;&nbsp;59</span>&nbsp;</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;&nbsp;60</span>&nbsp;&nbsp;&nbsp;&nbsp; resolver.BuildGraph();</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;&nbsp;61</span>&nbsp;</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;&nbsp;62</span>&nbsp;&nbsp;&nbsp;&nbsp; resolver.Solve();</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;&nbsp;63</span>&nbsp;}</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;&nbsp;64</span>&nbsp;</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;&nbsp;65</span>&nbsp;BranchResolver::BranchResolver(vector&lt;Instruction&gt; *code)</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;&nbsp;66</span>&nbsp;: m_pCode(code)</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;&nbsp;67</span>&nbsp;{</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;&nbsp;68</span>&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: purple;">// Heuristic that should be measured/sampled. Assume 10% of instructions are branches.</span></pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;&nbsp;69</span>&nbsp;&nbsp;&nbsp;&nbsp; m_arcs.reserve(m_pCode-&gt;size() / 10);</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;&nbsp;70</span>&nbsp;}</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;&nbsp;71</span>&nbsp;</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;&nbsp;72</span>&nbsp;<span style="color: blue;">void</span> BranchResolver::BuildGraph()</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;&nbsp;73</span>&nbsp;{</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;&nbsp;74</span>&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: blue;">typedef</span> vector&lt;Instruction&gt; Code;</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;&nbsp;75</span>&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: blue;">const</span> Code::size_type nSize = m_pCode-&gt;size();</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;&nbsp;76</span>&nbsp;</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;&nbsp;77</span>&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: purple;">// Map of labels into the arcs vector. Index into arc vector contains the </span></pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;&nbsp;78</span>&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: purple;">// first branch source that appears after the label.&nbsp; Used when</span></pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;&nbsp;79</span>&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: purple;">// waiting for forward branch sources to the label.</span></pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;&nbsp;80</span>&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: blue;">typedef</span> unordered_map&lt;Label *, ArcVector::size_type&gt; MapOpenLabels;</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;&nbsp;81</span>&nbsp;&nbsp;&nbsp;&nbsp; MapOpenLabels mapOpenLabels;</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;&nbsp;82</span>&nbsp;</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;&nbsp;83</span>&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: purple;">// This is the map of forward arcs for which a branch has been</span></pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;&nbsp;84</span>&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: purple;">// seen, but the closing label has not. The label is the key</span></pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;&nbsp;85</span>&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: purple;">// and the index into the branch vector is the value</span></pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;&nbsp;86</span>&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: blue;">typedef</span> unordered_multimap&lt;Label*, ArcVector::size_type&gt; MapOpenBranches;</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;&nbsp;87</span>&nbsp;&nbsp;&nbsp;&nbsp; MapOpenBranches mapOpenBranches;</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;&nbsp;88</span>&nbsp;</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;&nbsp;89</span>&nbsp;&nbsp;&nbsp;&nbsp; size_t nByteOffset = 0; <span style="color: purple;">// byte offset tracker for final bytecode generation</span></pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;&nbsp;90</span>&nbsp;</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;&nbsp;91</span>&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: purple;">// walk all instructions</span></pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;&nbsp;92</span>&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: blue;">for</span> (Code::size_type i = 0; i &lt; nSize; ++i)</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;&nbsp;93</span>&nbsp;&nbsp;&nbsp;&nbsp; {</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;&nbsp;94</span>&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; Instruction &amp;op = m_pCode-&gt;at(i);</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;&nbsp;95</span>&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; nByteOffset += op.size;</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;&nbsp;96</span>&nbsp;</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;&nbsp;97</span>&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; <span style="color: blue;">if</span> (OP_LABEL == op.opcode)</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;&nbsp;98</span>&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; {</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;&nbsp;99</span>&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; Label *pLabel = (Label*)op.pParam;</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;100</span>&nbsp;</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;101</span>&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; Code::size_type nSeenBranches = 0;</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;102</span>&nbsp;</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;103</span>&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; pLabel-&gt;nExpectedByteOffset = nByteOffset;</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;104</span>&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; pair&lt;MapOpenBranches::iterator, MapOpenBranches::iterator&gt; labelSources;</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;105</span>&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; labelSources = mapOpenBranches.equal_range(pLabel);</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;106</span>&nbsp;</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;107</span>&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; <span style="color: blue;">if</span> (labelSources.first != labelSources.second)</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;108</span>&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; {&nbsp;&nbsp;&nbsp; <span style="color: purple;">// some seen branches targetted this label</span></pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;109</span>&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; <span style="color: purple;">// Resolve those arcs</span></pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;110</span>&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; <span style="color: blue;">for</span> (; labelSources.first != labelSources.second; ++labelSources.first)</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;111</span>&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; {</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;112</span>&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; ArcVector::size_type index = labelSources.first-&gt;second;</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;113</span>&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; m_arcs[index].nLabelDistance = nByteOffset - m_arcs[index].nBranchByteOffest;</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;114</span>&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; }</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;115</span>&nbsp;</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;116</span>&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; <span style="color: purple;">// Now we can get rid of them.</span></pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;117</span>&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; nSeenBranches = mapOpenBranches.erase(pLabel);</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;118</span>&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; }</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;119</span>&nbsp;</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;120</span>&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; <span style="color: blue;">if</span> (nSeenBranches &lt; pLabel-&gt;nNumRefs)</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;121</span>&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; {&nbsp;&nbsp;&nbsp; <span style="color: purple;">// There be back edges to this label remaining!</span></pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;122</span>&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; pLabel-&gt;nNumRefs -= nSeenBranches; <span style="color: purple;">// modify to remaining pending branch source count</span></pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;123</span>&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; pLabel-&gt;nExpectedByteOffset = nByteOffset;</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;124</span>&nbsp;</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;125</span>&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; <span style="color: purple;">// Set a marker so when we see the target branch we know what nodes</span></pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;126</span>&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; <span style="color: purple;">// in the graph need to be targetted.</span></pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;127</span>&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; ASSERT(mapOpenLabels.count(pLabel) == 0);</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;128</span>&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; mapOpenLabels[pLabel] = m_arcs.size();</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;129</span>&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; }</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;130</span>&nbsp;</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;131</span>&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; <span style="color: blue;">if</span> ((nSeenBranches == 0) &amp;&amp; (pLabel-&gt;nNumRefs == 0))</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;132</span>&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; {</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;133</span>&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; ASSERT(<span style="color: blue;">false</span> &amp;&amp; <span style="color: #a31515;">&quot;Erm, label with zero refs showed up. Technically ok, but why???&quot;</span>);</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;134</span>&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; }</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;135</span>&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; }</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;136</span>&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; <span style="color: blue;">else</span> <span style="color: blue;">if</span> (OP_BR_UNRESOLVED == op.opcode)</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;137</span>&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; {&nbsp;&nbsp;&nbsp; <span style="color: purple;">// branch instruction</span></pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;138</span>&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; ASSERT(op.size == BR_UNRESOLVED_SIZE);</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;139</span>&nbsp;</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;140</span>&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; Label *pLabel = (Label*)op.pParam;</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;141</span>&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; ArcVector::size_type idxBranch = m_arcs.size();</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;142</span>&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; BranchArc arc;</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;143</span>&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; arc.nLabelDistance = 0;</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;144</span>&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; arc.nFixupDistance = 0;</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;145</span>&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; arc.nInstructionIndex = i;</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;146</span>&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; arc.nBranchByteOffest = nByteOffset;</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;147</span>&nbsp;</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;148</span>&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; m_arcs.push_back(arc);</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;149</span>&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; m_graph.AddNode(idxBranch);</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;150</span>&nbsp;</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;151</span>&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; <span style="color: purple;">// Deal with any labels we've already seen.</span></pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;152</span>&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; pair&lt;MapOpenLabels::iterator, MapOpenLabels::iterator&gt; labelSources;</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;153</span>&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; labelSources = mapOpenLabels.equal_range(pLabel);</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;154</span>&nbsp;</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;155</span>&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; <span style="color: blue;">if</span> (labelSources.first != labelSources.second)</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;156</span>&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; {&nbsp;&nbsp;&nbsp; <span style="color: purple;">// seen the label targetted by this branch</span></pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;157</span>&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; ASSERT(mapOpenLabels.count(pLabel) == 1); <span style="color: purple;">// should never be more than one label defn</span></pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;158</span>&nbsp;</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;159</span>&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; <span style="color: purple;">// Set the arc branch distance</span></pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;160</span>&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; m_arcs[idxBranch].nLabelDistance = arc.nLabelDistance = pLabel-&gt;nExpectedByteOffset - nByteOffset;</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;161</span>&nbsp;</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;162</span>&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; <span style="color: purple;">// Now point this arc at all the branch sources we've seen since the label was defined.</span></pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;163</span>&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; ArcVector::size_type idxSpannedBranches = labelSources.first-&gt;second;</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;164</span>&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; <span style="color: blue;">for</span> (;idxSpannedBranches &lt; idxBranch; ++idxSpannedBranches)</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;165</span>&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; {</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;166</span>&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; <span style="color: purple;">// This is the connector for back arcs</span></pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;167</span>&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; m_graph.Connect(idxBranch, idxSpannedBranches);</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;168</span>&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; }</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;169</span>&nbsp;</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;170</span>&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; <span style="color: purple;">// Decrement the label's branch ref count. If zero, no longer an open branch</span></pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;171</span>&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; pLabel-&gt;nNumRefs--;</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;172</span>&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; <span style="color: blue;">if</span> (0 == pLabel-&gt;nNumRefs)</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;173</span>&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; {</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;174</span>&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; mapOpenLabels.erase(pLabel);</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;175</span>&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; }</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;176</span>&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; }</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;177</span>&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; <span style="color: blue;">else</span></pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;178</span>&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; {&nbsp;&nbsp;&nbsp; <span style="color: purple;">// Haven't seen label, let this branch hang around until we do</span></pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;179</span>&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; mapOpenBranches.insert(MapOpenBranches::value_type(pLabel, idxBranch));</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;180</span>&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; }</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;181</span>&nbsp;</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;182</span>&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; <span style="color: purple;">// OK, now connect up to any forward reaching arcs that encompass this</span></pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;183</span>&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; <span style="color: purple;">// branch source.</span></pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;184</span>&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; <span style="color: blue;">for</span> <span style="color: blue;">each</span> (pair&lt;Label*, ArcVector::size_type&gt; openBranch <span style="color: blue;">in</span> mapOpenBranches)</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;185</span>&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; {</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;186</span>&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; <span style="color: blue;">if</span> (openBranch.second != idxBranch)</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;187</span>&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; {&nbsp;&nbsp;&nbsp; <span style="color: purple;">// This is the connector for forward arcs</span></pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;188</span>&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; m_graph.Connect(openBranch.second, idxBranch);</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;189</span>&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; }</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;190</span>&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; }</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;191</span>&nbsp;</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;192</span>&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; } <span style="color: purple;">// opcode == branch</span></pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;193</span>&nbsp;&nbsp;&nbsp;&nbsp; } <span style="color: purple;">// for all instructions</span></pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;194</span>&nbsp;}&nbsp;&nbsp;&nbsp; </pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;195</span>&nbsp;</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;196</span>&nbsp;<span style="color: blue;">void</span> BranchResolver::Solve()</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;197</span>&nbsp;{</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;198</span>&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: blue;">bool</span> bGraphChanged = <span style="color: blue;">false</span>;</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;199</span>&nbsp;&nbsp;&nbsp;&nbsp; m_graph.NewVisited();</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;200</span>&nbsp;</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;201</span>&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: blue;">do</span>&nbsp;&nbsp;&nbsp; <span style="color: purple;">// Main algorithm</span></pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;202</span>&nbsp;&nbsp;&nbsp;&nbsp; {</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;203</span>&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; m_graph.NewColor();</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;204</span>&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; bGraphChanged = <span style="color: blue;">false</span>;</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;205</span>&nbsp;</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;206</span>&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; <span style="color: purple;">// For each node, look for 'leaves' and bind them.</span></pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;207</span>&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; <span style="color: blue;">for</span> <span style="color: blue;">each</span> (pair&lt;ArcVector::size_type, ArcGraph::PNODE&gt; pairNode <span style="color: blue;">in</span> m_graph)</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;208</span>&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; {</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;209</span>&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; ArcGraph::PNODE pNode = pairNode.second;</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;210</span>&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; bGraphChanged |= Traverse(pNode);</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;211</span>&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; }</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;212</span>&nbsp;</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;213</span>&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; <span style="color: purple;">// Anything left is a cycle in the graph. ie: branches that cross over</span></pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;214</span>&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; <span style="color: purple;">// each other.&nbsp; Resolve any where we can determine with certainty the size</span></pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;215</span>&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; <span style="color: purple;">// of all the spanned branches.&nbsp; Also commit the branch size when doing it,</span></pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;216</span>&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; <span style="color: purple;">// once we believe a branch should be short or long, it better actually happen</span></pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;217</span>&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; <span style="color: purple;">// that way, or all spanning arcs will be 'off by 1'.</span></pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;218</span>&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; <span style="color: blue;">for</span> <span style="color: blue;">each</span> (pair&lt;ArcVector::size_type, ArcGraph::PNODE&gt; pairNode <span style="color: blue;">in</span> m_graph)</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;219</span>&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; {</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;220</span>&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; ArcGraph::PNODE pNode = pairNode.second;</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;221</span>&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; bGraphChanged |= BreakCycle(pNode);</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;222</span>&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; }</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;223</span>&nbsp;</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;224</span>&nbsp;&nbsp;&nbsp;&nbsp; } <span style="color: blue;">while</span> ((m_graph.DeleteVisited() != 0) || bGraphChanged);</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;225</span>&nbsp;</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;226</span>&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: purple;">// If we get here and they aren't all solved, we have hit a malicious case.</span></pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;227</span>&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: purple;">// Just make them long branches, or commit them to the size that was determined</span></pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;228</span>&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: purple;">// earlier with the assumption that all unsized arcs will be long.</span></pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;229</span>&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: blue;">for</span> <span style="color: blue;">each</span> (pair&lt;ArcVector::size_type, ArcGraph::PNODE&gt; pairNode <span style="color: blue;">in</span> m_graph)</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;230</span>&nbsp;&nbsp;&nbsp;&nbsp; {</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;231</span>&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; ArcGraph::PNODE pNode = pairNode.second;</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;232</span>&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; BranchArc &amp;arc(m_arcs[pNode-&gt;data]);</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;233</span>&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; Instruction &amp;instruction(m_pCode-&gt;at(arc.nInstructionIndex));</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;234</span>&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; <span style="color: blue;">int</span> nLocalFixup = 0;</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;235</span>&nbsp;</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;236</span>&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; <span style="color: blue;">for</span> <span style="color: blue;">each</span> (ArcGraph::PNODE pPointsTo <span style="color: blue;">in</span> pNode-&gt;setPointsTo)</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;237</span>&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; {</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;238</span>&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; <span style="color: blue;">if</span> (m_graph.GetVisited() == pPointsTo-&gt;nVisit)</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;239</span>&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; {</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;240</span>&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; <span style="color: blue;">continue</span>;</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;241</span>&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; }</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;242</span>&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; <span style="color: purple;">// only count the size-unsolved, and assume they are long.</span></pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;243</span>&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; nLocalFixup += BR_SIZE_DIFF;</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;244</span>&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; }</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;245</span>&nbsp;</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;246</span>&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; <span style="color: purple;">// Technically we should mark it visited, but then we would have to update the pointsfrom</span></pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;247</span>&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; <span style="color: purple;">// set to update the nFixupDistance.&nbsp; Since we /know/ this is the last time through</span></pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;248</span>&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; <span style="color: purple;">// the loop, just leave them all alive, so that they are continually accounted for</span></pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;249</span>&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; <span style="color: purple;">// in the inner 'for each' above.</span></pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;250</span>&nbsp;</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;251</span>&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; <span style="color: purple;">// pNode-&gt;nVisit = m_graph.GetVisited();</span></pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;252</span>&nbsp;</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;253</span>&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; <span style="color: blue;">if</span> (instruction.opcode == OP_BR_UNRESOLVED)</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;254</span>&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; {&nbsp;&nbsp;&nbsp; <span style="color: purple;">// assume long</span></pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;255</span>&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; instruction.opcode = OP_BR_L;</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;256</span>&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; instruction.size = BR_LONG_SIZE;</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;257</span>&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; }</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;258</span>&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; <span style="color: purple;">// commit size</span></pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;259</span>&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; <span style="color: blue;">int</span> nOffset = ExtendOffset(arc.nLabelDistance, arc.nFixupDistance + nLocalFixup, instruction.opcode == OP_BR_L);</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;260</span>&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; instruction.nParam = nOffset;</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;261</span>&nbsp;&nbsp;&nbsp;&nbsp; }</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;262</span>&nbsp;}</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;263</span>&nbsp;</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;264</span>&nbsp;<span style="color: purple;">// Traverse just resolves all non-cycle nodes, return of</span></pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;265</span>&nbsp;<span style="color: purple;">// false means a cycle was seen associated with this node.</span></pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;266</span>&nbsp;<span style="color: purple;">// true means it's been resolved</span></pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;267</span>&nbsp;<span style="color: blue;">bool</span> BranchResolver::Traverse(ArcGraph::PNODE pNode)</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;268</span>&nbsp;{</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;269</span>&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: blue;">if</span> (m_graph.GetVisited() == pNode-&gt;nVisit)</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;270</span>&nbsp;&nbsp;&nbsp;&nbsp; {&nbsp;&nbsp;&nbsp; <span style="color: purple;">// already processed</span></pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;271</span>&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; <span style="color: blue;">return</span> <span style="color: blue;">true</span>;</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;272</span>&nbsp;&nbsp;&nbsp;&nbsp; }</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;273</span>&nbsp;</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;274</span>&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: blue;">if</span> (m_graph.GetColor() == pNode-&gt;nColor)</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;275</span>&nbsp;&nbsp;&nbsp;&nbsp; {&nbsp;&nbsp;&nbsp; <span style="color: purple;">// already been here, cycle!</span></pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;276</span>&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; <span style="color: blue;">return</span> <span style="color: blue;">false</span>;</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;277</span>&nbsp;&nbsp;&nbsp;&nbsp; }</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;278</span>&nbsp;</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;279</span>&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: purple;">// color it</span></pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;280</span>&nbsp;&nbsp;&nbsp;&nbsp; pNode-&gt;nColor = m_graph.GetColor();</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;281</span>&nbsp;</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;282</span>&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: blue;">for</span> <span style="color: blue;">each</span> (ArcGraph::PNODE pPointsTo <span style="color: blue;">in</span> pNode-&gt;setPointsTo)</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;283</span>&nbsp;&nbsp;&nbsp;&nbsp; {</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;284</span>&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; <span style="color: blue;">if</span> (!Traverse(pPointsTo))</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;285</span>&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; {&nbsp;&nbsp;&nbsp; <span style="color: purple;">// cycle lower in the arc</span></pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;286</span>&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; <span style="color: blue;">return</span> <span style="color: blue;">false</span>;</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;287</span>&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; }</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;288</span>&nbsp;&nbsp;&nbsp;&nbsp; }</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;289</span>&nbsp;</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;290</span>&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: purple;">// Finally - encode it, no cycles</span></pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;291</span>&nbsp;&nbsp;&nbsp;&nbsp; OpCode newOp = OP_BR_S;</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;292</span>&nbsp;</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;293</span>&nbsp;&nbsp;&nbsp;&nbsp; BranchArc &amp;arc(m_arcs[pNode-&gt;data]);</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;294</span>&nbsp;&nbsp;&nbsp;&nbsp; Instruction &amp;instruction(m_pCode-&gt;at(arc.nInstructionIndex));</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;295</span>&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: blue;">bool</span> bFixupUpdate = <span style="color: blue;">false</span>;</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;296</span>&nbsp;</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;297</span>&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: blue;">int</span> nDistance = arc.nLabelDistance;</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;298</span>&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: blue;">if</span> (nDistance &lt;= 0)</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;299</span>&nbsp;&nbsp;&nbsp;&nbsp; {</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;300</span>&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; nDistance -= arc.nFixupDistance;</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;301</span>&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; <span style="color: blue;">if</span> (nDistance &lt; -128)</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;302</span>&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; {</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;303</span>&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; newOp = OP_BR_L;</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;304</span>&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; nDistance -= (BR_SIZE_DIFF); <span style="color: purple;">// 'long' instructions adjustment</span></pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;305</span>&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; ASSERT(instruction.opcode != OP_BR_S);</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;306</span>&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; instruction.size = BR_LONG_SIZE;</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;307</span>&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; bFixupUpdate = <span style="color: blue;">true</span>;</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;308</span>&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; }</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;309</span>&nbsp;&nbsp;&nbsp;&nbsp; }</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;310</span>&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: blue;">else</span></pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;311</span>&nbsp;&nbsp;&nbsp;&nbsp; {</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;312</span>&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; nDistance += arc.nFixupDistance;</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;313</span>&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; <span style="color: blue;">if</span> (nDistance &gt; 127)</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;314</span>&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; {</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;315</span>&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; newOp = OP_BR_L;</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;316</span>&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; ASSERT(instruction.opcode != OP_BR_S);</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;317</span>&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; instruction.size = BR_LONG_SIZE;</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;318</span>&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; bFixupUpdate = <span style="color: blue;">true</span>;</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;319</span>&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; }</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;320</span>&nbsp;&nbsp;&nbsp;&nbsp; }</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;321</span>&nbsp;</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;322</span>&nbsp;&nbsp;&nbsp;&nbsp; instruction.opcode = newOp;</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;323</span>&nbsp;&nbsp;&nbsp;&nbsp; instruction.nParam = nDistance;</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;324</span>&nbsp;</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;325</span>&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: blue;">if</span> (bFixupUpdate) <span style="color: purple;">// we went long, so patch up anyone who spanned us</span></pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;326</span>&nbsp;&nbsp;&nbsp;&nbsp; {</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;327</span>&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; <span style="color: purple;">// patch up everyone who directly points to us.</span></pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;328</span>&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; <span style="color: blue;">for</span> <span style="color: blue;">each</span> (ArcGraph::PNODE pPointsFrom <span style="color: blue;">in</span> pNode-&gt;setPointsFrom)</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;329</span>&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; {</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;330</span>&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; m_arcs[pPointsFrom-&gt;data].nFixupDistance += BR_SIZE_DIFF;</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;331</span>&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; }</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;332</span>&nbsp;&nbsp;&nbsp;&nbsp; }</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;333</span>&nbsp;</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;334</span>&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: purple;">// mark processed</span></pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;335</span>&nbsp;&nbsp;&nbsp;&nbsp; pNode-&gt;nVisit = m_graph.GetVisited();</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;336</span>&nbsp;</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;337</span>&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: blue;">return</span> <span style="color: blue;">true</span>;</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;338</span>&nbsp;}</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;339</span>&nbsp;</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;340</span>&nbsp;<span style="color: blue;">int</span> BranchResolver::ExtendOffset(<span style="color: blue;">int</span> nOriginal, size_t nDistance, <span style="color: blue;">bool</span> bLong)</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;341</span>&nbsp;{</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;342</span>&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: purple;">// Don't infer the longness from the distance - if there's a bug, doing so</span></pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;343</span>&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: purple;">// will propogate the error and make debugging harder.</span></pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;344</span>&nbsp;</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;345</span>&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: blue;">int</span> nLong = bLong ? BR_SIZE_DIFF : 0;</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;346</span>&nbsp;</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;347</span>&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: purple;">// If negative, add in the branch size adjustment if needed to skip over ourselves</span></pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;348</span>&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: blue;">return</span> (nOriginal &lt;= 0) ? nOriginal - (nDistance+nLong) : nOriginal + nDistance;</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;349</span>&nbsp;}</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;350</span>&nbsp;</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;351</span>&nbsp;<span style="color: purple;">// Break breakable cycles</span></pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;352</span>&nbsp;<span style="color: blue;">bool</span> BranchResolver::BreakCycle(ArcGraph::PNODE pNode)</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;353</span>&nbsp;{</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;354</span>&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: blue;">if</span> (m_graph.GetVisited() == pNode-&gt;nVisit)</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;355</span>&nbsp;&nbsp;&nbsp;&nbsp; {&nbsp;&nbsp;&nbsp; <span style="color: purple;">// already handled.</span></pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;356</span>&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; <span style="color: blue;">return</span> <span style="color: blue;">false</span>;</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;357</span>&nbsp;&nbsp;&nbsp;&nbsp; }</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;358</span>&nbsp;</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;359</span>&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: purple;">// Just lock in everything that can be 'trivially' known.</span></pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;360</span>&nbsp;</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;361</span>&nbsp;&nbsp;&nbsp;&nbsp; BranchArc &amp;arc(m_arcs[pNode-&gt;data]);</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;362</span>&nbsp;&nbsp;&nbsp;&nbsp; Instruction &amp;instruction(m_pCode-&gt;at(arc.nInstructionIndex));</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;363</span>&nbsp;</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;364</span>&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: purple;">// Figure out 'reasonably' what the size of the spanned branch instructions</span></pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;365</span>&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: purple;">// are in a way that won't cause circular lockout.</span></pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;366</span>&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: blue;">int</span>&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; nLocalFixup = 0;</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;367</span>&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: blue;">bool</span>&nbsp;&nbsp;&nbsp; bDistanceKnown = <span style="color: blue;">true</span>;</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;368</span>&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: blue;">for</span> <span style="color: blue;">each</span> (ArcGraph::PNODE pPointsTo <span style="color: blue;">in</span> pNode-&gt;setPointsTo)</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;369</span>&nbsp;&nbsp;&nbsp;&nbsp; {</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;370</span>&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; <span style="color: blue;">if</span> (m_graph.GetVisited() == pPointsTo-&gt;nVisit)</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;371</span>&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; {</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;372</span>&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; <span style="color: blue;">continue</span>;</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;373</span>&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; }</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;374</span>&nbsp;</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;375</span>&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; OpCode branchType = GetBranchType(pPointsTo);</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;376</span>&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; <span style="color: blue;">switch</span> (branchType)</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;377</span>&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; {</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;378</span>&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; <span style="color: blue;">case</span> OP_BR_S:</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;379</span>&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; <span style="color: blue;">break</span>;</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;380</span>&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; <span style="color: blue;">case</span> OP_BR_L:</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;381</span>&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; nLocalFixup += BR_SIZE_DIFF;</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;382</span>&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; <span style="color: blue;">break</span>;</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;383</span>&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; <span style="color: blue;">case</span> OP_BR_UNRESOLVED:</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;384</span>&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; bDistanceKnown = <span style="color: blue;">false</span>;</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;385</span>&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; <span style="color: blue;">break</span>;</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;386</span>&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; <span style="color: blue;">default</span>:</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;387</span>&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; ASSERT(<span style="color: blue;">false</span>);</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;388</span>&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; <span style="color: blue;">return</span> <span style="color: blue;">false</span>;</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;389</span>&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; }</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;390</span>&nbsp;</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;391</span>&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; <span style="color: blue;">if</span> (!bDistanceKnown)</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;392</span>&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; <span style="color: blue;">break</span>;</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;393</span>&nbsp;&nbsp;&nbsp;&nbsp; }</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;394</span>&nbsp;</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;395</span>&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: blue;">if</span> (bDistanceKnown)</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;396</span>&nbsp;&nbsp;&nbsp;&nbsp; {</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;397</span>&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; <span style="color: purple;">// OK. We know what size all enclosed instructions will end up being.</span></pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;398</span>&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; <span style="color: blue;">const</span> <span style="color: blue;">int</span> nLabelOffset&nbsp;&nbsp;&nbsp; = arc.nLabelDistance;</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;399</span>&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; nLocalFixup += arc.nFixupDistance; <span style="color: purple;">// Add in the fixup we already knew about...</span></pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;400</span>&nbsp;</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;401</span>&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; <span style="color: blue;">if</span> ((nLabelOffset &gt;= (-128 + nLocalFixup)) &amp;&amp; </pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;402</span>&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; (nLabelOffset &lt;= (127 - nLocalFixup)))</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;403</span>&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; {&nbsp;&nbsp;&nbsp; <span style="color: purple;">// short branch will work if spanned sizes are 'known'.</span></pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;404</span>&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; ASSERT(instruction.opcode != OP_BR_L);</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;405</span>&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; instruction.opcode = OP_BR_S;</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;406</span>&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; instruction.nParam = ExtendOffset(nLabelOffset, nLocalFixup, <span style="color: blue;">false</span>);</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;407</span>&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; }</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;408</span>&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; <span style="color: purple;">// if all the spanned branches are short, is it still too far?</span></pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;409</span>&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; <span style="color: blue;">else</span></pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;410</span>&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; {&nbsp;&nbsp;&nbsp; <span style="color: purple;">// needs a long branch</span></pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;411</span>&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; ASSERT(instruction.opcode != OP_BR_S);</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;412</span>&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; instruction.opcode = OP_BR_L;</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;413</span>&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; instruction.size = BR_LONG_SIZE;</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;414</span>&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; instruction.nParam = ExtendOffset(nLabelOffset, nLocalFixup, <span style="color: blue;">true</span>);</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;415</span>&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; }</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;416</span>&nbsp;</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;417</span>&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; <span style="color: blue;">if</span> (instruction.opcode == OP_BR_L)</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;418</span>&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; {</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;419</span>&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; <span style="color: purple;">// patch up everyone who directly points to us.</span></pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;420</span>&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; <span style="color: blue;">for</span> <span style="color: blue;">each</span> (ArcGraph::PNODE pPointsFrom <span style="color: blue;">in</span> pNode-&gt;setPointsFrom)</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;421</span>&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; {</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;422</span>&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; m_arcs[pPointsFrom-&gt;data].nFixupDistance += BR_SIZE_DIFF;</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;423</span>&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; }</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;424</span>&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; }</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;425</span>&nbsp;</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;426</span>&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; pNode-&gt;nVisit = m_graph.GetVisited();</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;427</span>&nbsp;&nbsp;&nbsp;&nbsp; }</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;428</span>&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: blue;">else</span> <span style="color: blue;">if</span> (instruction.opcode == OP_BR_UNRESOLVED)</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;429</span>&nbsp;&nbsp;&nbsp;&nbsp; {</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;430</span>&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; <span style="color: purple;">// distance not known yet, do we have a lock on our own</span></pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;431</span>&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; <span style="color: purple;">// instruction size at least? If so, lock it in.</span></pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;432</span>&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; <span style="color: blue;">switch</span> (GetBranchType(pNode))</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;433</span>&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; {</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;434</span>&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; <span style="color: blue;">case</span> OP_BR_S:</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;435</span>&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; instruction.opcode = OP_BR_S;</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;436</span>&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; ASSERT(instruction.size == BR_SHORT_SIZE);</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;437</span>&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; <span style="color: blue;">break</span>;</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;438</span>&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; <span style="color: blue;">case</span> OP_BR_L:</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;439</span>&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; instruction.opcode = OP_BR_L;</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;440</span>&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; instruction.size = BR_LONG_SIZE;</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;441</span>&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; <span style="color: blue;">break</span>;</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;442</span>&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; <span style="color: blue;">default</span>:</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;443</span>&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; <span style="color: blue;">return</span> <span style="color: blue;">false</span>; <span style="color: purple;">// we don't know anything. :(</span></pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;444</span>&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; }</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;445</span>&nbsp;</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;446</span>&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; <span style="color: purple;">// OK. We locked the instruction size, but don't know the distance</span></pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;447</span>&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; <span style="color: purple;">// for the branch for certain.&nbsp; We no longer participate as a member</span></pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;448</span>&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; <span style="color: purple;">// of the 'pointsTo' set since we have a known size.&nbsp; But we can't</span></pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;449</span>&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; <span style="color: purple;">// mark ourself visited since the instruction is only partially complete.</span></pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;450</span>&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; <span style="color: blue;">if</span> (instruction.size == BR_LONG_SIZE)</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;451</span>&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; {</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;452</span>&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; <span style="color: blue;">for</span> <span style="color: blue;">each</span> (ArcGraph::PNODE pPointsFrom <span style="color: blue;">in</span> pNode-&gt;setPointsFrom)</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;453</span>&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; {</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;454</span>&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; m_arcs[pPointsFrom-&gt;data].nFixupDistance += BR_SIZE_DIFF;</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;455</span>&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; }</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;456</span>&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; }</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;457</span>&nbsp;</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;458</span>&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; <span style="color: purple;">// Patch up everyone who directly points to us.</span></pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;459</span>&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; m_graph.DisconnectNodesTo(pNode-&gt;data);</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;460</span>&nbsp;&nbsp;&nbsp;&nbsp; }</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;461</span>&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: blue;">else</span></pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;462</span>&nbsp;&nbsp;&nbsp;&nbsp; {</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;463</span>&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; <span style="color: blue;">return</span> <span style="color: blue;">false</span>; <span style="color: purple;">// We haven't done anything</span></pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;464</span>&nbsp;&nbsp;&nbsp;&nbsp; }</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;465</span>&nbsp;</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;466</span>&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: purple;">// We changed the graph, maybe even solved something!</span></pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;467</span>&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: blue;">return</span> <span style="color: blue;">true</span>;</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;468</span>&nbsp;}</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;469</span>&nbsp;</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;470</span>&nbsp;<span style="color: purple;">// This routine determines if a branch instruction can unequivically</span></pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;471</span>&nbsp;<span style="color: purple;">// fit in a short; or will be required to fit in a long; or if it</span></pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;472</span>&nbsp;<span style="color: purple;">// is unknown.&nbsp; The upshot is that whatever this routine claims, that</span></pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;473</span>&nbsp;<span style="color: purple;">// branch must be encoded to that size (ie: no widening of something</span></pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;474</span>&nbsp;<span style="color: purple;">// this methods said would be short) - or else it will potentially</span></pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;475</span>&nbsp;<span style="color: purple;">// screw up branches that span the instruction.</span></pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;476</span>&nbsp;OpCode BranchResolver::GetBranchType(<span style="color: blue;">const</span> ArcGraph::PNODE pNode) <span style="color: blue;">const</span></pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;477</span>&nbsp;{</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;478</span>&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: blue;">const</span> BranchArc &amp;arc(m_arcs[pNode-&gt;data]);</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;479</span>&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: blue;">const</span> Instruction &amp;instruction(m_pCode-&gt;at(arc.nInstructionIndex));</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;480</span>&nbsp;</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;481</span>&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: blue;">if</span> (instruction.opcode != OP_BR_UNRESOLVED)</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;482</span>&nbsp;&nbsp;&nbsp;&nbsp; {</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;483</span>&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; <span style="color: purple;">// Did we figure this out already?</span></pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;484</span>&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; <span style="color: blue;">return</span> instruction.opcode; </pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;485</span>&nbsp;&nbsp;&nbsp;&nbsp; }</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;486</span>&nbsp;</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;487</span>&nbsp;&nbsp;&nbsp;&nbsp; size_t nSpannedBranches = 0;</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;488</span>&nbsp;</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;489</span>&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: purple;">// Figure out how many spanned branches have an unresolved size.</span></pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;490</span>&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: purple;">// (If the size of a spanned branch instruction was resolved, </span></pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;491</span>&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: purple;">// but not the distance it will have been removed from the set. </span></pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;492</span>&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: blue;">for</span> <span style="color: blue;">each</span> (ArcGraph::PNODE pPointsTo <span style="color: blue;">in</span> pNode-&gt;setPointsTo)</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;493</span>&nbsp;&nbsp;&nbsp;&nbsp; {</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;494</span>&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; <span style="color: blue;">if</span> (m_graph.GetVisited() == pPointsTo-&gt;nVisit)</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;495</span>&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; {</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;496</span>&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; <span style="color: blue;">continue</span>;</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;497</span>&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; }</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;498</span>&nbsp;</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;499</span>&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; nSpannedBranches++;</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;500</span>&nbsp;&nbsp;&nbsp;&nbsp; }</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;501</span>&nbsp;</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;502</span>&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: blue;">const</span> <span style="color: blue;">int</span> nLabelOffset&nbsp;&nbsp;&nbsp; = arc.nLabelDistance;</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;503</span>&nbsp;</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;504</span>&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: purple;">// max adjustment if all spanned unknowns are long.</span></pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;505</span>&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: blue;">const</span> <span style="color: blue;">int</span> nMaxFixup&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; = nSpannedBranches * BR_SIZE_DIFF + arc.nFixupDistance;</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;506</span>&nbsp;</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;507</span>&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: purple;">// min adjustment if all spanned are short (pretty easy to compute :) )</span></pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;508</span>&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: blue;">const</span> <span style="color: blue;">int</span> nMinFixup&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; = arc.nFixupDistance;</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;509</span>&nbsp;</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;510</span>&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: purple;">// can we do short even if all unknowned are long?</span></pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;511</span>&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: blue;">if</span> ((nLabelOffset &gt;= (-128 + nMaxFixup)) &amp;&amp; </pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;512</span>&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; (nLabelOffset &lt;= (127 - nMaxFixup)))</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;513</span>&nbsp;&nbsp;&nbsp;&nbsp; {&nbsp;&nbsp;&nbsp; <span style="color: purple;">// short branch will work</span></pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;514</span>&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; <span style="color: blue;">return</span> OP_BR_S;</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;515</span>&nbsp;&nbsp;&nbsp;&nbsp; }</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;516</span>&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: purple;">// if all the spanned branches are short, is it still too far?</span></pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;517</span>&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: blue;">else</span> <span style="color: blue;">if</span> ((nLabelOffset &lt; (-128 + nMinFixup))||</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;518</span>&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp; (nLabelOffset &gt; (127 - nMinFixup)))</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;519</span>&nbsp;&nbsp;&nbsp;&nbsp; {&nbsp;&nbsp;&nbsp; <span style="color: purple;">// needs a long branch</span></pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;520</span>&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; <span style="color: blue;">return</span> OP_BR_L;</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;521</span>&nbsp;&nbsp;&nbsp;&nbsp; }</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;522</span>&nbsp;</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;523</span>&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: purple;">// We still know nothing.</span></pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;524</span>&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: blue;">return</span> OP_BR_UNRESOLVED;</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;525</span>&nbsp;}</pre>
</div>

		</div><!-- End content -->
	</div><!-- End main content wrapper -->
	
	<div class="clearer"></div>
	
	<div id="footer"><!-- Start Footer -->
		<div id="breadcrumbcontainer"><!-- Start the breadcrumb wrapper -->
			
		</div><!-- End breadcrumb -->
		<p>&copy; 2009 Joe Rohde <a href="#" id="rw_email_contact">Contact Me</a><script type="text/javascript">var _rwObsfuscatedHref0 = "mai";var _rwObsfuscatedHref1 = "lto";var _rwObsfuscatedHref2 = ":Jo";var _rwObsfuscatedHref3 = "e.R";var _rwObsfuscatedHref4 = "ohd";var _rwObsfuscatedHref5 = "e@G";var _rwObsfuscatedHref6 = "Mai";var _rwObsfuscatedHref7 = "l.c";var _rwObsfuscatedHref8 = "om";var _rwObsfuscatedHref = _rwObsfuscatedHref0+_rwObsfuscatedHref1+_rwObsfuscatedHref2+_rwObsfuscatedHref3+_rwObsfuscatedHref4+_rwObsfuscatedHref5+_rwObsfuscatedHref6+_rwObsfuscatedHref7+_rwObsfuscatedHref8; document.getElementById('rw_email_contact').href = _rwObsfuscatedHref;</script></p>
	</div><!-- End Footer -->

</div><!-- End container -->
</body>
</html>
