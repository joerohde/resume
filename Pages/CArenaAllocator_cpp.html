<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
	<head>
		<meta http-equiv="content-type" content="text/html; charset=utf-8" />
		<meta name="robots" content="all" />
		<meta name="generator" content="RapidWeaver" />
		
		<title>CArenaAllocator.cpp</title>
		<link rel="stylesheet" type="text/css" media="screen" href="../rw_common/themes/interslice/styles.css"  />
		<link rel="stylesheet" type="text/css" media="print" href="../rw_common/themes/interslice/print.css"  />
		<link rel="stylesheet" type="text/css" media="handheld" href="../rw_common/themes/interslice/handheld.css"  />
		<link rel="stylesheet" type="text/css" media="screen" href="../rw_common/themes/interslice/css/width/width_variable.css" />
		<link rel="stylesheet" type="text/css" media="screen" href="../rw_common/themes/interslice/css/sidebar/sidebar_left.css" />
		
		
		
		
		<script type="text/javascript" src="../rw_common/themes/interslice/javascript.js"></script>
		
		
		
	</head>
<body>
<div id="container"><!-- Start container -->
	
	<div id="pageHeader"><!-- Start page header -->
		
		<h1>Joe Rohde's Info</h1>
		<h2>Will Code For Food</h2>
	</div><!-- End page header -->
	
	<div id="sidebarContainer"><!-- Start Sidebar wrapper -->
		<div id="navcontainer"><!-- Start Navigation -->
			<ul><li><a href="../index.html" rel="self">Code Samples</a></li><li><a href="../Pages/CArenaAllocator.html" rel="self">CArenaAllocator.h</a></li><li><a href="CArenaAllocator_cpp.html" rel="self" id="current">CArenaAllocator.cpp</a></li><li><a href="../Pages/Tree.html" rel="self">Tree.h</a></li><li><a href="../Pages/TreeMain.html" rel="self">TreeMain.cpp</a></li><li><a href="../Pages/TreeOutput.html" rel="self">Tree Output</a></li><li><a href="../Pages/DirectedGraph.html" rel="self">DirectedGraph.h</a></li><li><a href="../Pages/Instruction.html" rel="self">Instruction.h</a></li><li><a href="../Pages/Instruction_cpp.html" rel="self">Instruction.cpp</a></li><li><a href="../Pages/TestHarness.html" rel="self">TestHarness.cpp</a></li></ul>
		</div><!-- End navigation --> 
		<div id="sidebar"><!-- Start sidebar content -->
			<h1 class="sideHeader"></h1><!-- Sidebar header -->
			 <br /><!-- sidebar content you enter in the page inspector -->
			 <!-- sidebar content such as the blog archive links -->
		</div><!-- End sidebar content -->
	</div><!-- End sidebar wrapper -->
	
	<div id="contentContainer"><!-- Start main content wrapper -->
		<div id="content"><!-- Start content -->
			<H1>CArenaAllocator.cpp</H1>
<div style="font-family: Bitstream Vera Sans Mono; font-size: 10pt; color: black; background: white;">
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;&nbsp;&nbsp;1</span>&nbsp;<span style="color: purple;">// This is a class for a a specific pattern of memory allocation.</span></pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;&nbsp;&nbsp;2</span>&nbsp;<span style="color: purple;">// When an environment needs:</span></pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;&nbsp;&nbsp;3</span>&nbsp;<span style="color: purple;">// - dynamic allocation of many objects</span></pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;&nbsp;&nbsp;4</span>&nbsp;<span style="color: purple;">// - of the same or varying sizes</span></pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;&nbsp;&nbsp;5</span>&nbsp;<span style="color: purple;">// - the max size is known</span></pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;&nbsp;&nbsp;6</span>&nbsp;<span style="color: purple;">// - all the objects of a group can be released at once.</span></pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;&nbsp;&nbsp;7</span>&nbsp;<span style="color: purple;">//</span></pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;&nbsp;&nbsp;8</span>&nbsp;<span style="color: purple;">// Create an arena for the life of the 'pool'.&nbsp; Allocations</span></pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;&nbsp;&nbsp;9</span>&nbsp;<span style="color: purple;">// are time O(1).&nbsp; Free is O(1).&nbsp; Finally free is basically</span></pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;&nbsp;10</span>&nbsp;<span style="color: purple;">// the time it takes to call free on each large chunk.</span></pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;&nbsp;11</span>&nbsp;<span style="color: purple;">//</span></pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;&nbsp;12</span>&nbsp;<span style="color: purple;">// This pattern is common in parsers where a parse tree per</span></pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;&nbsp;13</span>&nbsp;<span style="color: purple;">// 'function' is created and the whole tree can be dumped when</span></pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;&nbsp;14</span>&nbsp;<span style="color: purple;">// done with it.</span></pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;&nbsp;15</span>&nbsp;</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;&nbsp;16</span>&nbsp;<span style="color: blue;">#include</span> <span style="color: #a31515;">&quot;PreCompile.h&quot;</span></pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;&nbsp;17</span>&nbsp;</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;&nbsp;18</span>&nbsp;<span style="color: blue;">#include</span> <span style="color: #a31515;">&quot;os.h&quot;</span></pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;&nbsp;19</span>&nbsp;<span style="color: blue;">#include</span> <span style="color: #a31515;">&quot;CArenaAllocator.h&quot;</span></pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;&nbsp;20</span>&nbsp;</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;&nbsp;21</span>&nbsp;<span style="color: blue;">#if</span> <span style="color: blue;">defined</span>(_DEBUG) || <span style="color: blue;">defined</span>(_WANT_STATS)</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;&nbsp;22</span>&nbsp;<span style="color: blue;">#define</span> _MARKER_SIZE 4</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;&nbsp;23</span>&nbsp;<span style="color: blue;">#endif</span></pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;&nbsp;24</span>&nbsp;</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;&nbsp;25</span>&nbsp;<span style="color: blue;">#ifdef</span> _DEBUG</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;&nbsp;26</span>&nbsp;</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;&nbsp;27</span>&nbsp;<span style="color: blue;">static</span> <span style="color: blue;">const</span> BYTE _HEAD_MARKER[_MARKER_SIZE] = { 0xDE, 0xAD, 0xBE, 0xEF };</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;&nbsp;28</span>&nbsp;<span style="color: blue;">static</span> <span style="color: blue;">const</span> BYTE _TAIL_MARKER[_MARKER_SIZE] = { 0xFE, 0xEB, 0xDA, 0xED };</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;&nbsp;29</span>&nbsp;</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;&nbsp;30</span>&nbsp;<span style="color: purple;">// Overlay on the front of an arbitrary allocation</span></pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;&nbsp;31</span>&nbsp;<span style="color: blue;">struct</span> CArenaAllocHeader</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;&nbsp;32</span>&nbsp;{</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;&nbsp;33</span>&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: purple;">// so we can find the tail marker and the next allocation</span></pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;&nbsp;34</span>&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: blue;">unsigned</span> <span style="color: blue;">short</span>&nbsp;&nbsp;&nbsp; nAllocationSize; <span style="color: purple;">// Not including pre/post buffers</span></pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;&nbsp;35</span>&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: blue;">unsigned</span> <span style="color: blue;">short</span>&nbsp;&nbsp;&nbsp; nDeleteCount;</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;&nbsp;36</span>&nbsp;&nbsp;&nbsp;&nbsp; BYTE&nbsp;&nbsp;&nbsp; marker[_MARKER_SIZE];</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;&nbsp;37</span>&nbsp;</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;&nbsp;38</span>&nbsp;&nbsp;&nbsp;&nbsp; BYTE *Buffer() <span style="color: blue;">const</span> { <span style="color: blue;">return</span> ((BYTE*)<span style="color: blue;">this</span> + ALIGN_TO_POINTER(<span style="color: blue;">sizeof</span>(CArenaAllocHeader))); }</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;&nbsp;39</span>&nbsp;&nbsp;&nbsp;&nbsp; BYTE *TailMarker() <span style="color: blue;">const</span> { <span style="color: blue;">return</span> Buffer() + <span style="color: blue;">this</span>-&gt;nAllocationSize; }</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;&nbsp;40</span>&nbsp;&nbsp;&nbsp;&nbsp; CArenaAllocHeader* Next() <span style="color: blue;">const</span> { <span style="color: blue;">return</span> (CArenaAllocHeader*)(Buffer() + ALIGN_TO_POINTER(<span style="color: blue;">this</span>-&gt;nAllocationSize + _MARKER_SIZE)); }</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;&nbsp;41</span>&nbsp;};</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;&nbsp;42</span>&nbsp;</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;&nbsp;43</span>&nbsp;<span style="color: blue;">static</span> <span style="color: blue;">void</span> AddAllocMarkers(CArenaAllocHeader *pHeader);</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;&nbsp;44</span>&nbsp;<span style="color: blue;">static</span> <span style="color: blue;">void</span> VerifyPage(<span style="color: blue;">const</span> CArenaPageHeader *pHeader);</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;&nbsp;45</span>&nbsp;<span style="color: blue;">static</span> <span style="color: blue;">void</span> VerifyDeadAllocation(<span style="color: blue;">const</span> CArenaAllocHeader *pHeader);</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;&nbsp;46</span>&nbsp;</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;&nbsp;47</span>&nbsp;<span style="color: blue;">#endif</span></pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;&nbsp;48</span>&nbsp;</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;&nbsp;49</span>&nbsp;<span style="color: purple;">// Overlay on the front of each page.</span></pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;&nbsp;50</span>&nbsp;<span style="color: blue;">struct</span> CArenaPageHeader</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;&nbsp;51</span>&nbsp;{</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;&nbsp;52</span>&nbsp;&nbsp;&nbsp;&nbsp; CArenaPageHeader&nbsp;&nbsp;&nbsp; *pNextPage;</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;&nbsp;53</span>&nbsp;&nbsp;&nbsp;&nbsp; BYTE *Buffer() <span style="color: blue;">const</span> { <span style="color: blue;">return</span> ((BYTE*)<span style="color: blue;">this</span> + ALIGN_TO_POINTER(<span style="color: blue;">sizeof</span>(CArenaPageHeader))); }</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;&nbsp;54</span>&nbsp;</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;&nbsp;55</span>&nbsp;<span style="color: blue;">#ifdef</span> _DEBUG</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;&nbsp;56</span>&nbsp;&nbsp;&nbsp;&nbsp; BYTE&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; *highWaterMark;</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;&nbsp;57</span>&nbsp;&nbsp;&nbsp;&nbsp; size_t&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; nPageSize; <span style="color: purple;">// does include any Pre/Post Buffers!</span></pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;&nbsp;58</span>&nbsp;&nbsp;&nbsp;&nbsp; BYTE&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; marker[_MARKER_SIZE];</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;&nbsp;59</span>&nbsp;</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;&nbsp;60</span>&nbsp;&nbsp;&nbsp;&nbsp; BYTE *TailMarker() <span style="color: blue;">const</span> { <span style="color: blue;">return</span> (BYTE*)<span style="color: blue;">this</span> + <span style="color: blue;">this</span>-&gt;nPageSize - _MARKER_SIZE; }</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;&nbsp;61</span>&nbsp;<span style="color: blue;">#endif</span></pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;&nbsp;62</span>&nbsp;};</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;&nbsp;63</span>&nbsp;</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;&nbsp;64</span>&nbsp;CArenaAllocator::CArenaAllocator() :</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;&nbsp;65</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; m_pCurrPage(0), m_pCurrentFree(0), m_pBarrier(0)</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;&nbsp;66</span>&nbsp;{</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;&nbsp;67</span>&nbsp;<span style="color: blue;">#ifdef</span> _WANT_STATS</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;&nbsp;68</span>&nbsp;&nbsp;&nbsp;&nbsp; m_totalBytesAllocated = 0;</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;&nbsp;69</span>&nbsp;&nbsp;&nbsp;&nbsp; m_totalBytesRequested = 0;</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;&nbsp;70</span>&nbsp;&nbsp;&nbsp;&nbsp; m_pagesAllocated = 0;</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;&nbsp;71</span>&nbsp;&nbsp;&nbsp;&nbsp; m_numRequests = 0;</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;&nbsp;72</span>&nbsp;<span style="color: blue;">#endif</span></pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;&nbsp;73</span>&nbsp;</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;&nbsp;74</span>&nbsp;<span style="color: blue;">#ifndef</span> _DEBUG</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;&nbsp;75</span>&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: purple;">// Should be our /only/ overhead in release mode.</span></pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;&nbsp;76</span>&nbsp;&nbsp;&nbsp;&nbsp; StaticAssert(<span style="color: blue;">sizeof</span>(CArenaPageHeader) == <span style="color: blue;">sizeof</span>(BYTE*));</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;&nbsp;77</span>&nbsp;<span style="color: blue;">#endif</span></pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;&nbsp;78</span>&nbsp;}</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;&nbsp;79</span>&nbsp;</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;&nbsp;80</span>&nbsp;CArenaAllocator::~CArenaAllocator()</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;&nbsp;81</span>&nbsp;{</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;&nbsp;82</span>&nbsp;&nbsp;&nbsp;&nbsp; FreeAllPages();</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;&nbsp;83</span>&nbsp;}</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;&nbsp;84</span>&nbsp;</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;&nbsp;85</span>&nbsp;<span style="color: blue;">void</span> CArenaAllocator::MakeFirstPage()</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;&nbsp;86</span>&nbsp;{</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;&nbsp;87</span>&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: purple;">// An interpreter is often instantiated just to evaluate variables being passed </span></pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;&nbsp;88</span>&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: purple;">// across scripts.&nbsp; This often ends up in a parse tree with 0-ish bytes.&nbsp; </span></pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;&nbsp;89</span>&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: purple;">// In addition, a new parse/binary tree is built for 'eval' statements.&nbsp; </span></pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;&nbsp;90</span>&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: purple;">// These tend to go anywhere from 16 to 256 bytes (tending to the smaller) </span></pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;&nbsp;91</span>&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: purple;">// unless the eval was machine generated.&nbsp; As such, defer creating the </span></pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;&nbsp;92</span>&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: purple;">// first page until there is a request for memory - this optimizes for the</span></pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;&nbsp;93</span>&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: purple;">// running of scripts that don't take parms.&nbsp; Then make the&nbsp; first page much </span></pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;&nbsp;94</span>&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: purple;">// smaller than normal to optimize for the 'some parameters to a script' </span></pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;&nbsp;95</span>&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: purple;">// case, and the 'eval' case.</span></pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;&nbsp;96</span>&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: blue;">const</span> size_t kFirstPageSize = 192;</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;&nbsp;97</span>&nbsp;&nbsp;&nbsp;&nbsp; m_pCurrPage = <span style="color: blue;">new</span> BYTE[ kFirstPageSize ];</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;&nbsp;98</span>&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: blue;">if</span> (m_pCurrPage == NULL)</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;&nbsp;99</span>&nbsp;&nbsp;&nbsp;&nbsp; {</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;100</span>&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; <span style="color: blue;">return</span>;</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;101</span>&nbsp;&nbsp;&nbsp;&nbsp; }</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;102</span>&nbsp;&nbsp;&nbsp;&nbsp; m_pBarrier = m_pCurrPage + kFirstPageSize;</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;103</span>&nbsp;</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;104</span>&nbsp;&nbsp;&nbsp;&nbsp; CArenaPageHeader *pHeader = (CArenaPageHeader *)m_pCurrPage;</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;105</span>&nbsp;&nbsp;&nbsp;&nbsp; m_pCurrentFree = pHeader-&gt;Buffer();</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;106</span>&nbsp;&nbsp;&nbsp;&nbsp; pHeader-&gt;pNextPage = NULL;</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;107</span>&nbsp;</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;108</span>&nbsp;&nbsp;&nbsp;&nbsp; DBG_ONLY(pHeader-&gt;nPageSize = kFirstPageSize);</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;109</span>&nbsp;&nbsp;&nbsp;&nbsp; DBG_ONLY(AddPageMarkers(pHeader));</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;110</span>&nbsp;</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;111</span>&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: purple;">// Don't count overhead. We want to know how many bytes of page get left over.</span></pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;112</span>&nbsp;&nbsp;&nbsp;&nbsp; STAT_ONLY(m_totalBytesAllocated = kFirstPageSize - <span style="color: blue;">sizeof</span>(CArenaPageHeader) - _MARKER_SIZE);</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;113</span>&nbsp;&nbsp;&nbsp;&nbsp; STAT_ONLY(m_pagesAllocated = 1);</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;114</span>&nbsp;}</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;115</span>&nbsp;</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;116</span>&nbsp;<span style="color: blue;">void</span> CArenaAllocator::FreeAllPages()</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;117</span>&nbsp;{</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;118</span>&nbsp;<span style="color: blue;">#ifdef</span> _WANT_ARENA_STATS</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;119</span>&nbsp;&nbsp;&nbsp;&nbsp; SD2(<span style="color: #a31515;">&quot;&nbsp;&nbsp; Arena: # of Requests:&nbsp;&nbsp; %d\n&quot;</span>, m_numRequests);</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;120</span>&nbsp;&nbsp;&nbsp;&nbsp; SD2(<span style="color: #a31515;">&quot;&nbsp;&nbsp; Arena: Bytes Requested: %d\n&quot;</span>, m_totalBytesRequested);</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;121</span>&nbsp;&nbsp;&nbsp;&nbsp; SD2(<span style="color: #a31515;">&quot;&nbsp;&nbsp; Arena: Bytes Allocated: %d\n&quot;</span>, m_totalBytesAllocated);</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;122</span>&nbsp;&nbsp;&nbsp;&nbsp; SD2(<span style="color: #a31515;">&quot;&nbsp;&nbsp; Arena: Pages Allocated: %d\n&quot;</span>, m_pagesAllocated);</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;123</span>&nbsp;<span style="color: blue;">#endif</span></pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;124</span>&nbsp;&nbsp;&nbsp;&nbsp; CArenaPageHeader *pPage = (CArenaPageHeader *)m_pCurrPage;</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;125</span>&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: blue;">while</span> (pPage)</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;126</span>&nbsp;&nbsp;&nbsp;&nbsp; {</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;127</span>&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; DBG_ONLY( VerifyPage( pPage ) );</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;128</span>&nbsp;</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;129</span>&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; CArenaPageHeader *pNextPage = pPage-&gt;pNextPage;</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;130</span>&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; <span style="color: blue;">delete</span> [] pPage;</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;131</span>&nbsp;</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;132</span>&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; pPage = pNextPage;</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;133</span>&nbsp;&nbsp;&nbsp;&nbsp; }</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;134</span>&nbsp;}</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;135</span>&nbsp;</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;136</span>&nbsp;<span style="color: blue;">void</span> *CArenaAllocator::GrowPagesAndAllocate(size_t nMinSize) <span style="color: purple;">// return value can be returned to user</span></pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;137</span>&nbsp;{</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;138</span>&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: blue;">const</span> size_t kIdealPageSize = 4096; <span style="color: purple;">// paramter to constructor? DAL_Variable? Both?</span></pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;139</span>&nbsp;</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;140</span>&nbsp;&nbsp;&nbsp;&nbsp; Assert(m_pCurrentFree + nMinSize &gt; m_pBarrier);</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;141</span>&nbsp;</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;142</span>&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: purple;">// Get the 1st page?</span></pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;143</span>&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: blue;">if</span> (m_pCurrentFree == NULL)</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;144</span>&nbsp;&nbsp;&nbsp;&nbsp; {</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;145</span>&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; MakeFirstPage();</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;146</span>&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; <span style="color: blue;">if</span> (m_pCurrentFree == NULL)</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;147</span>&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; {</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;148</span>&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; <span style="color: blue;">return</span> NULL;</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;149</span>&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; }</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;150</span>&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; <span style="color: purple;">// Didn't have a page. Now we do, see if the</span></pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;151</span>&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; <span style="color: purple;">// request actually fit</span></pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;152</span>&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; <span style="color: blue;">if</span> (m_pCurrentFree + nMinSize &lt;= m_pBarrier)</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;153</span>&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; {</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;154</span>&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; <span style="color: blue;">void</span> *pMem = m_pCurrentFree;</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;155</span>&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; m_pCurrentFree += ALIGN_TO_POINTER(nMinSize);</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;156</span>&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; <span style="color: blue;">return</span> pMem;</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;157</span>&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; }</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;158</span>&nbsp;&nbsp;&nbsp;&nbsp; }</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;159</span>&nbsp;</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;160</span>&nbsp;&nbsp;&nbsp;&nbsp; size_t nBytesToAllocate = kIdealPageSize;</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;161</span>&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: blue;">bool</span> bOrphanBlock = <span style="color: blue;">false</span>;</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;162</span>&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: purple;">// min page size is size of block requested, size of header, and size of tail marker</span></pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;163</span>&nbsp;&nbsp;&nbsp;&nbsp; size_t nMinPageSize = nMinSize + ALIGN_TO_POINTER(<span style="color: blue;">sizeof</span>(CArenaPageHeader));</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;164</span>&nbsp;&nbsp;&nbsp;&nbsp; DBG_ONLY( nMinPageSize += _MARKER_SIZE ); <span style="color: purple;">// tail marker in debug</span></pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;165</span>&nbsp;</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;166</span>&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: blue;">if</span> (nMinPageSize &gt; (kIdealPageSize&gt;&gt;1) )</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;167</span>&nbsp;&nbsp;&nbsp;&nbsp; {</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;168</span>&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; <span style="color: purple;">// Need to handle the case where the requested block is larger than</span></pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;169</span>&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; <span style="color: purple;">// our ideal block size.&nbsp; In addition, if it's bigger than 1/2 the </span></pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;170</span>&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; <span style="color: purple;">// ideal size and didn't fit, let's also give it a dedicated block.</span></pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;171</span>&nbsp;</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;172</span>&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; <span style="color: purple;">// Insert a 'finished' page to the page list. </span></pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;173</span>&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; <span style="color: purple;">// This lets the next allocation try to use the remaining space</span></pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;174</span>&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; <span style="color: purple;">// in the current page.</span></pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;175</span>&nbsp;</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;176</span>&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; bOrphanBlock = <span style="color: blue;">true</span>;</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;177</span>&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; nBytesToAllocate = nMinPageSize;</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;178</span>&nbsp;&nbsp;&nbsp;&nbsp; }</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;179</span>&nbsp;</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;180</span>&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: purple;">// Don't count overhead. We want to know how many bytes of page get left over.</span></pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;181</span>&nbsp;&nbsp;&nbsp;&nbsp; STAT_ONLY(m_totalBytesAllocated += (nBytesToAllocate - <span style="color: blue;">sizeof</span>(CArenaPageHeader) - _MARKER_SIZE));</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;182</span>&nbsp;&nbsp;&nbsp;&nbsp; STAT_ONLY(m_pagesAllocated++);</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;183</span>&nbsp;</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;184</span>&nbsp;&nbsp;&nbsp;&nbsp; Assert(m_pCurrPage != NULL);</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;185</span>&nbsp;</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;186</span>&nbsp;&nbsp;&nbsp;&nbsp; CArenaPageHeader *pNewFirstPage = (CArenaPageHeader*)<span style="color: blue;">new</span> <span style="color: blue;">char</span>[ nBytesToAllocate ];</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;187</span>&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: blue;">if</span> (pNewFirstPage == NULL)</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;188</span>&nbsp;&nbsp;&nbsp;&nbsp; {</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;189</span>&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; <span style="color: blue;">return</span> NULL;</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;190</span>&nbsp;&nbsp;&nbsp;&nbsp; }</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;191</span>&nbsp;</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;192</span>&nbsp;&nbsp;&nbsp;&nbsp; pNewFirstPage-&gt;pNextPage = (CArenaPageHeader *)m_pCurrPage;</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;193</span>&nbsp;&nbsp;&nbsp;&nbsp; DBG_ONLY(pNewFirstPage-&gt;nPageSize = nBytesToAllocate);</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;194</span>&nbsp;</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;195</span>&nbsp;&nbsp;&nbsp;&nbsp; m_pCurrPage = (BYTE*)pNewFirstPage;</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;196</span>&nbsp;&nbsp;&nbsp;&nbsp; BYTE* pMem = pNewFirstPage-&gt;Buffer();</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;197</span>&nbsp;</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;198</span>&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: purple;">// Did we actually make a new arena page,</span></pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;199</span>&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: purple;">// or just a 1-off orphan?</span></pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;200</span>&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: blue;">if</span> (!bOrphanBlock)</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;201</span>&nbsp;&nbsp;&nbsp;&nbsp; {</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;202</span>&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; m_pBarrier = (BYTE*)pNewFirstPage + nBytesToAllocate;</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;203</span>&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; m_pCurrentFree = pMem + ALIGN_TO_POINTER(nMinSize);</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;204</span>&nbsp;&nbsp;&nbsp;&nbsp; }</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;205</span>&nbsp;</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;206</span>&nbsp;&nbsp;&nbsp;&nbsp; DBG_ONLY(AddPageMarkers(pNewFirstPage));</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;207</span>&nbsp;</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;208</span>&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: blue;">return</span> pMem;</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;209</span>&nbsp;}</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;210</span>&nbsp;</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;211</span>&nbsp;<span style="color: blue;">#ifdef</span> _DEBUG</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;212</span>&nbsp;<span style="color: blue;">void</span> *CArenaAllocator::DbgAllocate(size_t nBytesRequested)</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;213</span>&nbsp;{</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;214</span>&nbsp;&nbsp;&nbsp;&nbsp; m_totalBytesRequested += nBytesRequested;</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;215</span>&nbsp;&nbsp;&nbsp;&nbsp; m_numRequests++;</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;216</span>&nbsp;</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;217</span>&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: purple;">// Make room for guard markers and info</span></pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;218</span>&nbsp;&nbsp;&nbsp;&nbsp; size_t nBytes = nBytesRequested + ALIGN_TO_POINTER((<span style="color: blue;">sizeof</span>(CArenaAllocHeader)) + _MARKER_SIZE);</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;219</span>&nbsp;</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;220</span>&nbsp;&nbsp;&nbsp;&nbsp; BYTE *pMem;</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;221</span>&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: purple;">// m_pBarrier is the 1st illegal address</span></pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;222</span>&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: blue;">if</span> (m_pCurrentFree + nBytes &lt;= m_pBarrier)</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;223</span>&nbsp;&nbsp;&nbsp;&nbsp; {</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;224</span>&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; pMem = m_pCurrentFree;</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;225</span>&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; m_pCurrentFree += ALIGN_TO_POINTER(nBytes);</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;226</span>&nbsp;&nbsp;&nbsp;&nbsp; }</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;227</span>&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: blue;">else</span></pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;228</span>&nbsp;&nbsp;&nbsp;&nbsp; {</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;229</span>&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; pMem = (BYTE*)GrowPagesAndAllocate(nBytes); <span style="color: purple;">// GrowPages responsible for fixing up state</span></pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;230</span>&nbsp;&nbsp;&nbsp;&nbsp; }</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;231</span>&nbsp;</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;232</span>&nbsp;&nbsp;&nbsp;&nbsp; CArenaAllocHeader *pHeader = (CArenaAllocHeader*) pMem;</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;233</span>&nbsp;&nbsp;&nbsp;&nbsp; Assert(nBytesRequested &lt;= 0xFFFF); <span style="color: purple;">// nAllocationSize is a short</span></pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;234</span>&nbsp;&nbsp;&nbsp;&nbsp; pHeader-&gt;nAllocationSize = CAST_TO_USHORT( MIN( nBytesRequested, 0xFFFFu )); <span style="color: purple;">// Does not include header/marker space!!!</span></pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;235</span>&nbsp;&nbsp;&nbsp;&nbsp; AddAllocMarkers(pHeader);</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;236</span>&nbsp;</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;237</span>&nbsp;&nbsp;&nbsp;&nbsp; CArenaPageHeader *pPage = (CArenaPageHeader*)m_pCurrPage;</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;238</span>&nbsp;&nbsp;&nbsp;&nbsp; pPage-&gt;highWaterMark = m_pCurrentFree;</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;239</span>&nbsp;</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;240</span>&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: blue;">return</span> pHeader-&gt;Buffer();</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;241</span>&nbsp;}</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;242</span>&nbsp;</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;243</span>&nbsp;<span style="color: purple;">// Verify and dirty up that space</span></pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;244</span>&nbsp;<span style="color: blue;">void</span> CArenaAllocator::DbgDeleteHelper(<span style="color: blue;">void</span> *ptr)</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;245</span>&nbsp;{</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;246</span>&nbsp;&nbsp;&nbsp;&nbsp; BYTE *pbyteHeader = (BYTE*)ptr - ALIGN_TO_POINTER(<span style="color: blue;">sizeof</span>(CArenaAllocHeader));</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;247</span>&nbsp;&nbsp;&nbsp;&nbsp; CArenaAllocHeader *pHeader = (CArenaAllocHeader*)pbyteHeader;</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;248</span>&nbsp;&nbsp;&nbsp;&nbsp; pHeader-&gt;nDeleteCount++;</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;249</span>&nbsp;&nbsp;&nbsp;&nbsp; VerifyDeadAllocation(pHeader);</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;250</span>&nbsp;</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;251</span>&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: purple;">// Crush the data in case someone tries to read from it after destruction</span></pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;252</span>&nbsp;&nbsp;&nbsp;&nbsp; memset(ptr, 0xCA, pHeader-&gt;nAllocationSize);</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;253</span>&nbsp;}</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;254</span>&nbsp;</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;255</span>&nbsp;<span style="color: blue;">static</span> <span style="color: blue;">void</span> AddAllocMarkers(CArenaAllocHeader *pHeader)</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;256</span>&nbsp;{</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;257</span>&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: purple;">// While we take pretty good care to make sure we handle align correctly</span></pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;258</span>&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: purple;">// in general, we would need to code the 'underflow' stuff more carefully</span></pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;259</span>&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: purple;">// if we don't have natural alignmenment on the header. If we don't</span></pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;260</span>&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: purple;">// naturally align after the header, the current code would leave a 'gap'</span></pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;261</span>&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: purple;">// that we would not detect an underflow over-write in.</span></pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;262</span>&nbsp;&nbsp;&nbsp;&nbsp; StaticAssert(<span style="color: blue;">sizeof</span>(CArenaAllocHeader) == ALIGN_TO_POINTER(<span style="color: blue;">sizeof</span>(CArenaAllocHeader)));</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;263</span>&nbsp;</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;264</span>&nbsp;&nbsp;&nbsp;&nbsp; pHeader-&gt;nDeleteCount = 0;</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;265</span>&nbsp;&nbsp;&nbsp;&nbsp; memcpy(pHeader-&gt;marker, _HEAD_MARKER, _MARKER_SIZE);</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;266</span>&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: blue;">if</span> (pHeader-&gt;nAllocationSize != 0xFFFF)</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;267</span>&nbsp;&nbsp;&nbsp;&nbsp; {</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;268</span>&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; BYTE *pTailMarker = pHeader-&gt;TailMarker();</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;269</span>&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; memcpy(pTailMarker, _TAIL_MARKER, _MARKER_SIZE);</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;270</span>&nbsp;&nbsp;&nbsp;&nbsp; }</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;271</span>&nbsp;}</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;272</span>&nbsp;</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;273</span>&nbsp;<span style="color: blue;">void</span> CArenaAllocator::AddPageMarkers(CArenaPageHeader *pHeader)</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;274</span>&nbsp;{</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;275</span>&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: purple;">// While we take pretty good care to make sure we handle align correctly</span></pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;276</span>&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: purple;">// in general, we would need to code the 'underflow' stuff more carefully</span></pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;277</span>&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: purple;">// if we don't have natural alignmenment on the header. If we don't</span></pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;278</span>&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: purple;">// naturally align after the header, the current code would leave a 'gap'</span></pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;279</span>&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: purple;">// that we would not detect an underflow over-write in.</span></pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;280</span>&nbsp;&nbsp;&nbsp;&nbsp; StaticAssert(<span style="color: blue;">sizeof</span>(CArenaPageHeader) == ALIGN_TO_POINTER(<span style="color: blue;">sizeof</span>(CArenaPageHeader)));</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;281</span>&nbsp;</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;282</span>&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: purple;">// Flip head/tail markers at the page level.</span></pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;283</span>&nbsp;&nbsp;&nbsp;&nbsp; m_pBarrier -= _MARKER_SIZE;</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;284</span>&nbsp;&nbsp;&nbsp;&nbsp; Assert(m_pBarrier &gt; m_pCurrentFree); <span style="color: purple;">// if this fails our pages are too small</span></pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;285</span>&nbsp;&nbsp;&nbsp;&nbsp; pHeader-&gt;highWaterMark = pHeader-&gt;Buffer();</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;286</span>&nbsp;&nbsp;&nbsp;&nbsp; memcpy(pHeader-&gt;marker, _TAIL_MARKER, _MARKER_SIZE);</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;287</span>&nbsp;&nbsp;&nbsp;&nbsp; memcpy(pHeader-&gt;TailMarker(), _HEAD_MARKER, _MARKER_SIZE);</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;288</span>&nbsp;}</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;289</span>&nbsp;</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;290</span>&nbsp;<span style="color: blue;">static</span> <span style="color: blue;">void</span> VerifyPage(<span style="color: blue;">const</span> CArenaPageHeader *pPage)</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;291</span>&nbsp;{</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;292</span>&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: purple;">// HEAD/TAIL markers are used other way around for 'page' level marking.</span></pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;293</span>&nbsp;&nbsp;&nbsp;&nbsp; Assert(memcmp(pPage-&gt;marker, _TAIL_MARKER, _MARKER_SIZE) == 0);</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;294</span>&nbsp;&nbsp;&nbsp;&nbsp; BYTE *pEndPageMarker = pPage-&gt;TailMarker();</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;295</span>&nbsp;&nbsp;&nbsp;&nbsp; Assert(memcmp(pEndPageMarker, _HEAD_MARKER, _MARKER_SIZE) == 0);</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;296</span>&nbsp;</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;297</span>&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: purple;">// Look for any non-destructor called objects in the page.</span></pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;298</span>&nbsp;&nbsp;&nbsp;&nbsp; BYTE *pAlloc = pPage-&gt;Buffer();</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;299</span>&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: blue;">while</span> (pAlloc &lt; pPage-&gt;highWaterMark)</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;300</span>&nbsp;&nbsp;&nbsp;&nbsp; {</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;301</span>&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; CArenaAllocHeader *pAllocHeader = (CArenaAllocHeader *)pAlloc;</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;302</span>&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; VerifyDeadAllocation(pAllocHeader);</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;303</span>&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; pAlloc = (BYTE*)pAllocHeader-&gt;Next();</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;304</span>&nbsp;&nbsp;&nbsp;&nbsp; }</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;305</span>&nbsp;</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;306</span>&nbsp;}</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;307</span>&nbsp;</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;308</span>&nbsp;<span style="color: blue;">static</span> <span style="color: blue;">void</span> VerifyDeadAllocation(<span style="color: blue;">const</span> CArenaAllocHeader *pHeader)</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;309</span>&nbsp;{</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;310</span>&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: purple;">// If any of these asserts fire on a reproducable pHeader address,</span></pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;311</span>&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: purple;">// set a conditional breakpoint on the return statement of </span></pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;312</span>&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: purple;">// DbgAllocate() for pHeader and check the call stack.</span></pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;313</span>&nbsp;&nbsp;&nbsp;&nbsp; Assert(pHeader-&gt;nDeleteCount != 0); <span style="color: purple;">// Never deleted!</span></pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;314</span>&nbsp;&nbsp;&nbsp;&nbsp; Assert(pHeader-&gt;nDeleteCount == 1); <span style="color: purple;">// Multi-Delete calls!</span></pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;315</span>&nbsp;&nbsp;&nbsp;&nbsp; Assert(memcmp(pHeader-&gt;marker, _HEAD_MARKER, _MARKER_SIZE) == 0); <span style="color: purple;">// Underrun!</span></pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;316</span>&nbsp;</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;317</span>&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: blue;">if</span> (pHeader-&gt;nAllocationSize != 0xFFFF) <span style="color: purple;">// request was too big</span></pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;318</span>&nbsp;&nbsp;&nbsp;&nbsp; {</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;319</span>&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; BYTE *pTailMarker = pHeader-&gt;TailMarker();</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;320</span>&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; <span style="color: purple;">// Overrun!</span></pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;321</span>&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; Assert(memcmp(pTailMarker, _TAIL_MARKER, _MARKER_SIZE) == 0);</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;322</span>&nbsp;&nbsp;&nbsp;&nbsp; }</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;323</span>&nbsp;}</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;324</span>&nbsp;</pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;325</span>&nbsp;<span style="color: blue;">#endif</span></pre>
<pre style="margin: 0px;"><span style="color: #2b91af;">&nbsp;&nbsp;326</span>&nbsp;</pre>
</div>

		</div><!-- End content -->
	</div><!-- End main content wrapper -->
	
	<div class="clearer"></div>
	
	<div id="footer"><!-- Start Footer -->
		<div id="breadcrumbcontainer"><!-- Start the breadcrumb wrapper -->
			
		</div><!-- End breadcrumb -->
		<p>&copy; 2009 Joe Rohde <a href="#" id="rw_email_contact">Contact Me</a><script type="text/javascript">var _rwObsfuscatedHref0 = "mai";var _rwObsfuscatedHref1 = "lto";var _rwObsfuscatedHref2 = ":Jo";var _rwObsfuscatedHref3 = "e.R";var _rwObsfuscatedHref4 = "ohd";var _rwObsfuscatedHref5 = "e@G";var _rwObsfuscatedHref6 = "Mai";var _rwObsfuscatedHref7 = "l.c";var _rwObsfuscatedHref8 = "om";var _rwObsfuscatedHref = _rwObsfuscatedHref0+_rwObsfuscatedHref1+_rwObsfuscatedHref2+_rwObsfuscatedHref3+_rwObsfuscatedHref4+_rwObsfuscatedHref5+_rwObsfuscatedHref6+_rwObsfuscatedHref7+_rwObsfuscatedHref8; document.getElementById('rw_email_contact').href = _rwObsfuscatedHref;</script></p>
	</div><!-- End Footer -->

</div><!-- End container -->
</body>
</html>
